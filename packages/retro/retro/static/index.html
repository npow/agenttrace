<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Claude Retro</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
/* Dark theme (default) — matches agentsview */
:root {
  --bg: #0d0d12;
  --surface: #16161e;
  --surface2: #1f1f2a;
  --inset: #111116;
  --border: #2b2b38;
  --border-muted: #232330;
  --text: #e4e6eb;
  --text-sec: #9ea5b4;
  --text-dim: #6c7385;
  --accent: #60a5fa;
  --accent2: #a78bfa;
  --green: #34d399;
  --yellow: #fbbf24;
  --red: #f87171;
  --orange: #fb923c;
  --blue: #60a5fa;
  --purple: #a78bfa;
  --cyan: #22d3ee;
  --amber: #d97706;
  --radius: 6px;
  --overlay: rgba(0,0,0,0.6);
  --shadow: 0 2px 8px rgba(0,0,0,0.35);
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.25);
  --shadow-md: 0 2px 8px rgba(0,0,0,0.35);
  --shadow-lg: 0 4px 16px rgba(0,0,0,0.4);
  --user-bg: #111827;
  --assistant-bg: #141220;
  --tool-bg: #1a1508;
  --font-mono: 'JetBrains Mono', 'SF Mono', 'Fira Code', Menlo, Consolas, monospace;
}
/* Light theme */
[data-theme="light"] {
  --bg: #f5f6f8;
  --surface: #ffffff;
  --surface2: #f0f1f4;
  --inset: #ecedf2;
  --border: #d8dae2;
  --border-muted: #e4e6ec;
  --text: #181b24;
  --text-sec: #555b6e;
  --text-dim: #878ea0;
  --accent: #2563eb;
  --accent2: #7c3aed;
  --green: #059669;
  --yellow: #ca8a04;
  --red: #dc2626;
  --orange: #ea580c;
  --blue: #2563eb;
  --purple: #7c3aed;
  --cyan: #0891b2;
  --amber: #d97706;
  --overlay: rgba(0,0,0,0.3);
  --shadow: 0 2px 8px rgba(0,0,0,0.08);
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
  --shadow-md: 0 2px 8px rgba(0,0,0,0.08);
  --shadow-lg: 0 4px 16px rgba(0,0,0,0.1);
  --user-bg: #eef2ff;
  --assistant-bg: #faf9ff;
  --tool-bg: #fffbf0;
}
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
  font-size: 13px; line-height: 1.5;
  -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
  font-feature-settings: 'cv11', 'ss01'; text-rendering: optimizeLegibility;
  background: var(--bg); color: var(--text);
  min-height: 100vh;
  transition: background-color 0.3s, color 0.3s;
}
/* Scrollbar */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }
::selection { background: var(--accent); color: white; }
:focus-visible { outline: 2px solid var(--accent); outline-offset: 1px; }
button { font: inherit; color: inherit; background: none; border: none; cursor: pointer; }
button:disabled { opacity: 0.5; cursor: not-allowed; }
input, select { font: inherit; color: inherit; }
a { color: var(--accent); text-decoration: none; }
a:hover { text-decoration: underline; }

/* Loading spinner */
.loading {
  display: flex; align-items: center; justify-content: center;
  padding: 40px; color: var(--text-dim);
}
.spinner {
  display: inline-block; width: 20px; height: 20px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Full-width layout */
.page { max-width: none; margin: 0; padding: 16px 32px 80px; }

/* Top bar — matches agentsview header */
.top-bar {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 16px; padding: 0 0 10px; border-bottom: 1px solid var(--border);
  position: relative; gap: 10px;
}
.top-bar h1 { font-size: 12px; font-weight: 650; color: var(--text); letter-spacing: -0.01em; white-space: nowrap; }
.top-bar h1 span { color: var(--text-dim); font-weight: 400; }
.refresh-btn {
  height: 26px; padding: 0 10px; border-radius: 4px; font-size: 11px;
  font-weight: 500; cursor: pointer; white-space: nowrap;
  background: color-mix(in srgb, var(--accent) 12%, transparent);
  color: var(--accent); border: 1px solid color-mix(in srgb, var(--accent) 25%, transparent);
  transition: background 0.1s, color 0.1s;
}
.refresh-btn:hover { background: color-mix(in srgb, var(--accent) 20%, transparent); }
.refresh-btn:disabled { opacity: 0.5; cursor: not-allowed; }

/* ===== THE VERDICT ===== */
.verdict {
  background: var(--surface); border: 1px solid var(--border-muted); border-radius: var(--radius);
  padding: 12px; margin-bottom: 16px;
}
.verdict-summary {
  font-size: 14px; font-weight: 500; line-height: 1.6; margin-bottom: 10px;
  color: var(--text-sec);
}
.verdict-summary strong { color: var(--text); font-weight: 600; }
.verdict-bar-wrap { margin-bottom: 6px; }
.verdict-bar {
  height: 8px; border-radius: 4px; overflow: hidden; display: flex;
  background: var(--inset);
}
.verdict-bar .productive { background: var(--green); transition: width 0.4s; }
.verdict-bar .waste { background: var(--red); opacity: 0.5; transition: width 0.4s; }
.verdict-bar-labels {
  display: flex; justify-content: space-between; font-size: 10px;
  color: var(--text-dim); margin-top: 3px;
}
/* Stat cards — exact agentsview SummaryCards pattern */
.stat-cards {
  display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px;
}
.stat-card {
  flex: 1; min-width: 120px; padding: 12px;
  background: var(--surface); border: 1px solid var(--border-muted); border-radius: var(--radius);
  display: flex; flex-direction: column; gap: 2px;
}
.stat-card .stat-value { font-size: 20px; font-weight: 600; line-height: 1.2; color: var(--text); }
.stat-card .stat-label { font-size: 11px; font-weight: 500; color: var(--text-dim); }
.stat-card .stat-sub { font-size: 10px; color: var(--text-dim); margin-top: 2px; }

/* ===== CHANGE THESE 3 THINGS ===== */
.section-label {
  font-size: 10px; color: var(--text-dim); font-weight: 600; margin-bottom: 8px;
  text-transform: uppercase; letter-spacing: 0.02em;
}
/* ===== CHANGE CARDS — redesigned ===== */
.change-cards {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 10px; margin-bottom: 16px; align-items: start;
}
.cc-card {
  background: var(--surface); border: 1px solid var(--border-muted);
  border-radius: var(--radius); overflow: hidden;
  display: flex; flex-direction: column;
}
.cc-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 12px 8px; border-bottom: 1px solid var(--border-muted);
  gap: 8px;
}
.cc-project {
  font-size: 13px; font-weight: 600; color: var(--text);
  display: flex; align-items: center; gap: 6px; min-width: 0;
}
.cc-project-icon { font-size: 13px; flex-shrink: 0; }
.cc-num {
  font-size: 9px; font-weight: 700; color: var(--text-dim);
  letter-spacing: 0.05em; text-transform: uppercase; flex-shrink: 0;
}
/* Metrics row — 2-3 widgets side by side */
.cc-metrics {
  display: grid; grid-template-columns: repeat(var(--cols, 3), 1fr);
  gap: 1px; background: var(--border-muted);
  border-bottom: 1px solid var(--border-muted);
}
.cc-metric {
  background: var(--surface); padding: 10px 12px 8px;
  display: flex; flex-direction: column; gap: 2px;
}
.cc-metric-val {
  font-size: 22px; font-weight: 700; line-height: 1; letter-spacing: -0.02em;
}
.cc-metric-delta {
  font-size: 10px; font-weight: 600; opacity: 0.75;
  margin-left: 3px; vertical-align: text-bottom;
}
.cc-metric-label {
  font-size: 9px; font-weight: 600; color: var(--text-dim);
  text-transform: uppercase; letter-spacing: 0.05em; margin-top: 3px;
}
.cc-metric-bar {
  height: 4px; background: var(--inset); border-radius: 2px; margin-top: 7px;
  position: relative; overflow: visible;
}
.cc-metric-bar-fill { height: 100%; border-radius: 2px; transition: width 0.4s; }
/* avg tick — a taller notch that pokes above/below the bar */
.cc-metric-bar-tick {
  position: absolute; top: -3px;
  width: 2px; height: 10px;
  background: var(--text-dim); border-radius: 1px;
  transform: translateX(-50%);
  opacity: 0.6;
}
/* Advice zone */
.cc-advice {
  padding: 9px 12px; font-size: 11px; color: var(--text-sec);
  line-height: 1.55; flex: 1;
}
.cc-advice-label {
  font-size: 9px; font-weight: 700; color: var(--text-dim);
  text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px;
}
/* CTA footer */
.cc-footer {
  padding: 8px 12px; border-top: 1px solid var(--border-muted);
  background: var(--inset);
}
.cc-cta {
  font-size: 11px; font-weight: 600; color: var(--accent);
  cursor: pointer; display: inline-flex; align-items: center; gap: 4px;
  padding: 3px 0;
}
.cc-cta:hover { text-decoration: underline; }
/* Plain text cards (non-project) */
.cc-plain-body {
  padding: 10px 12px; font-size: 11px; color: var(--text-dim); line-height: 1.55; flex: 1;
}
.cc-plain-link {
  font-size: 11px; color: var(--text-dim); padding: 0 12px 10px;
}

/* ===== SESSION FEED ===== */
.feed-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 8px; gap: 6px;
}
.filter-bar {
  display: flex; gap: 6px; align-items: center; flex: 1;
}
.filter-bar select {
  height: 26px; padding: 0 8px;
  background: var(--inset); border: 1px solid var(--border-muted); border-radius: 4px;
  color: var(--text-sec); font-size: 11px; outline: none; cursor: pointer;
  transition: border-color 0.15s; max-width: 200px;
}
.filter-bar select:focus { outline: none; border-color: var(--accent); }
/* Search input — agentsview search-hint style */
.filter-bar input {
  height: 26px; padding: 0 10px; margin-left: auto;
  background: var(--inset); border: 1px solid var(--border-muted); border-radius: var(--radius);
  color: var(--text-sec); font-size: 11px; outline: none;
  transition: border-color 0.15s, box-shadow 0.15s;
}
.filter-bar input::placeholder { color: var(--text-dim); }
.filter-bar input:focus { border-color: var(--border); box-shadow: var(--shadow-sm); }
.filter-bar input:hover { border-color: var(--border); }

.session-feed { display: flex; flex-direction: column; gap: 0; }

/* Session card — agentsview SessionItem pattern */
.s-card {
  display: flex; align-items: center; gap: 10px;
  padding: 8px 14px; cursor: pointer;
  border-left: 2px solid transparent;
  transition: background 0.1s;
  border-radius: 0;
}
.s-card:hover { background: var(--surface2); }
.s-card.expanded { background: var(--surface2); border-left-color: var(--accent); cursor: default; flex-wrap: wrap; align-items: flex-start; }
.s-card .s-detail { width: 100%; margin-top: 0; }
.s-row1 { display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0; }
.s-outcome {
  width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0;
  font-size: 0; overflow: hidden;
}
.s-prompt {
  flex: 1; font-size: 12px; color: var(--text); white-space: nowrap;
  overflow: hidden; text-overflow: ellipsis; font-weight: 450; min-width: 0;
  line-height: 1.3; letter-spacing: -0.005em;
}
.s-prod {
  font-size: 10px; font-weight: 600; padding: 1px 6px; border-radius: 8px;
  white-space: nowrap; flex-shrink: 0; text-transform: uppercase; letter-spacing: 0.03em;
}
.s-row2 {
  display: flex; align-items: center; gap: 6px; font-size: 10px;
  color: var(--text-dim); line-height: 1.3; letter-spacing: 0.01em;
}
.s-row2 .sep { color: var(--border); }
/* Inline problem callout */
.s-issue {
  display: flex; align-items: center; gap: 4px; font-size: 10px;
  color: var(--red); margin-top: 1px;
}
.s-issue .issue-icon { opacity: 0.6; font-size: 10px; }

/* Badges */
.badge {
  display: inline-block; padding: 2px 7px; border-radius: 4px;
  font-size: 10px; font-weight: 600; text-transform: uppercase;
}
.badge-completed { background: color-mix(in srgb, var(--green) 15%, transparent); color: var(--green); }
.badge-partially_completed { background: color-mix(in srgb, var(--yellow) 15%, transparent); color: var(--yellow); }
.badge-failed { background: color-mix(in srgb, var(--red) 15%, transparent); color: var(--red); }
.badge-exploratory { background: color-mix(in srgb, var(--cyan) 15%, transparent); color: var(--cyan); }
.badge-converged { background: color-mix(in srgb, var(--green) 15%, transparent); color: var(--green); }
.badge-drifted { background: color-mix(in srgb, var(--yellow) 15%, transparent); color: var(--yellow); }
.badge-thrashed { background: color-mix(in srgb, var(--red) 15%, transparent); color: var(--red); }
.badge-abandoned { background: color-mix(in srgb, var(--text-dim) 15%, transparent); color: var(--text-dim); }
.badge-mixed { background: color-mix(in srgb, var(--purple) 15%, transparent); color: var(--purple); }
.badge-unknown { background: color-mix(in srgb, var(--text-dim) 10%, transparent); color: var(--text-dim); }
.badge-implement { background: color-mix(in srgb, var(--accent) 15%, transparent); color: var(--accent2); }
.badge-debug { background: color-mix(in srgb, var(--red) 15%, transparent); color: var(--red); }
.badge-research { background: color-mix(in srgb, var(--cyan) 15%, transparent); color: var(--cyan); }
.badge-refactor { background: color-mix(in srgb, var(--purple) 15%, transparent); color: var(--purple); }
.badge-brainstorm { background: color-mix(in srgb, var(--yellow) 15%, transparent); color: var(--yellow); }
.badge-review { background: color-mix(in srgb, var(--green) 15%, transparent); color: var(--green); }
.badge-prototype { background: color-mix(in srgb, var(--orange) 15%, transparent); color: var(--orange); }

/* ===== EXPANDED SESSION DETAIL (in-place) ===== */
.s-detail {
  padding: 12px 16px 10px; border-top: 1px solid var(--border-muted);
  margin-top: 4px; animation: fadeIn 0.1s ease;
  background: var(--surface);
}
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.s-detail .detail-badges { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 8px; }

/* AI analysis sections */
.ai-section { margin-bottom: 10px; }
.ai-section .ai-label {
  font-size: 10px; color: var(--text-dim); font-weight: 600;
  margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.02em;
}
.ai-section .ai-body { font-size: 12px; color: var(--text-sec); line-height: 1.65; }
.ai-section .ai-body strong { color: var(--text); font-weight: 600; }

/* Quality bars */
.quality-bars { display: flex; gap: 12px; margin-bottom: 10px; }
.quality-bar { flex: 1; }
.quality-bar .bar-label { font-size: 10px; color: var(--text-dim); font-weight: 500; margin-bottom: 3px; }
.quality-bar .bar-track { height: 4px; background: var(--inset); border-radius: 2px; overflow: hidden; }
.quality-bar .bar-fill { height: 100%; border-radius: 2px; transition: width 0.3s; }
.quality-bar .bar-value { font-size: 10px; color: var(--text-dim); margin-top: 2px; }

/* Tags — micro pills */
.tag-list { display: flex; flex-wrap: wrap; gap: 3px; margin-bottom: 8px; }
.tag {
  display: inline-block; padding: 1px 5px; border-radius: 3px; font-size: 10px; font-weight: 500;
  background: var(--inset); border: 1px solid var(--border-muted); color: var(--text-sec);
}

/* Issue items — subtle: left border carries the role, background is barely tinted */
.issue-list { margin-bottom: 10px; display: flex; flex-direction: column; gap: 3px; }
.issue-item {
  display: flex; gap: 8px; padding: 6px 10px; border-radius: 0 4px 4px 0;
  font-size: 12px; border-left: 3px solid var(--border);
  background: transparent; transition: background 0.1s;
}
.issue-item:hover { background: var(--surface2); }
.issue-item.misalignment { border-left-color: var(--red); }
.issue-item.correction { border-left-color: var(--yellow); }
.issue-item.underspec { border-left-color: var(--orange); }
.issue-item .turn-num {
  color: var(--text-dim); white-space: nowrap; font-weight: 600; font-size: 10px;
  min-width: 44px; flex-shrink: 0;
}
.issue-item .issue-desc { color: var(--text-dim); line-height: 1.5; }
.issue-item .issue-context {
  margin-top: 4px; padding: 5px 8px; border-radius: 3px;
  font-size: 11px; line-height: 1.4; max-height: 56px; overflow: hidden;
  white-space: pre-wrap; word-break: break-word;
}
.issue-item .issue-context.ctx-user {
  background: color-mix(in srgb, var(--accent) 6%, transparent); border-left: 2px solid var(--accent); color: var(--accent2);
}
.issue-item .issue-context.ctx-assistant {
  background: color-mix(in srgb, var(--green) 5%, transparent); border-left: 2px solid var(--green); color: var(--text-dim);
}

/* Productivity bar */
.prod-bar-wrap { margin-bottom: 8px; }
.prod-bar-track { height: 6px; background: var(--inset); border-radius: 3px; overflow: hidden; display: flex; }
.prod-bar-track .productive { background: var(--green); }
.prod-bar-track .waste { background: var(--red); opacity: 0.5; }
.prod-bar-labels { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-dim); margin-top: 2px; }

/* Tool usage bar chart */
.tool-chart-wrap { margin-bottom: 8px; }
.tool-bar-row { display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
.tool-bar-name {
  width: 90px; text-align: right; color: var(--text-dim); overflow: hidden;
  text-overflow: ellipsis; white-space: nowrap; flex-shrink: 0;
  font-family: var(--font-mono); font-size: 10px;
}
.tool-bar-track { flex: 1; height: 6px; background: var(--inset); border-radius: 3px; overflow: hidden; }
.tool-bar-fill { height: 100%; background: var(--accent); border-radius: 3px; transition: width 0.3s; }
.tool-bar-count { width: 28px; font-size: 10px; color: var(--text-dim); text-align: right; font-variant-numeric: tabular-nums; }

/* Collapsible timeline — uses msg-entry style */
.timeline-toggle {
  font-size: 11px; color: var(--text-dim); cursor: pointer; margin-bottom: 6px;
  display: inline-flex; align-items: center; gap: 4px;
  padding: 4px 8px; border-radius: 4px;
  transition: background 0.1s, color 0.1s;
  border: 1px solid var(--border-muted); background: var(--inset);
}
.timeline-toggle:hover { background: var(--surface2); color: var(--text); border-color: var(--border); }
.timeline-content { display: none; max-height: 400px; overflow-y: auto; padding: 4px 0; }
.timeline-content.open { display: block; }
/* Timeline message entries — same visual language as modal */
.tl-msg {
  border-left: 3px solid var(--border-muted); padding: 6px 10px; margin-bottom: 2px;
  border-radius: 0 4px 4px 0; font-size: 11px; transition: background 0.1s;
}
.tl-msg:hover { background: var(--surface2); }
.tl-msg.tl-user { border-left-color: var(--accent); background: color-mix(in srgb, var(--accent) 4%, transparent); }
.tl-msg.tl-assistant { border-left-color: var(--accent2); background: color-mix(in srgb, var(--accent2) 3%, transparent); }
.tl-msg.tl-system { border-left-color: var(--text-dim); }
.tl-msg .tl-header { display: flex; align-items: center; gap: 6px; }
.tl-msg .tl-role { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.02em; }
.tl-msg .tl-role.r-user { color: var(--accent); }
.tl-msg .tl-role.r-assistant { color: var(--accent2); }
.tl-msg .tl-role.r-system { color: var(--text-dim); }
.tl-msg .tl-time { font-size: 9px; color: var(--text-dim); margin-left: auto; font-variant-numeric: tabular-nums; }
.tl-msg .tl-preview { color: var(--text-dim); margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.tl-msg .tl-tools { display: flex; flex-direction: column; gap: 4px; margin-top: 4px; }
.tl-tool-call { border-left: 2px solid var(--border-muted); padding-left: 8px; }
.tl-tool-name {
  font-family: var(--font-mono); font-size: 10px; padding: 1px 6px; border-radius: 3px;
  background: var(--inset); border: 1px solid var(--border-muted); color: var(--text-sec);
  display: inline-block; margin-bottom: 2px;
}
.tl-tool-input { font-family: var(--font-mono); font-size: 10px; color: var(--text-dim); white-space: pre-wrap; word-break: break-all; }
.tl-tool-result { font-size: 10px; margin-top: 2px; padding: 2px 6px; border-radius: 3px; background: color-mix(in srgb, var(--green) 8%, transparent); color: var(--text-dim); white-space: pre-wrap; word-break: break-all; }
.tl-tool-result.tl-result-err { background: color-mix(in srgb, var(--red) 8%, transparent); color: var(--red); }

/* Load more */
.load-more {
  text-align: center; padding: 8px; cursor: pointer;
}
.load-more span {
  display: inline-block; height: 26px; padding: 0 12px; border-radius: 4px;
  font-size: 11px; font-weight: 500; color: var(--text-dim); line-height: 26px;
  border: 1px solid var(--border-muted); transition: background 0.1s, color 0.1s;
}
.load-more:hover span { background: var(--surface2); color: var(--text); }

/* ===== TABS — agentsview nav-btn style ===== */
.tab-bar {
  display: flex; gap: 2px; margin-bottom: 12px; padding: 4px 0;
}
.tab-btn {
  height: 26px; padding: 0 10px; border-radius: 4px;
  font-size: 11px; font-weight: 500; color: var(--text-dim);
  cursor: pointer; border: none; background: none; white-space: nowrap;
  transition: background 0.12s, color 0.12s;
}
.tab-btn:hover { background: var(--surface2); color: var(--text); }
.tab-btn.active { color: var(--accent); background: color-mix(in srgb, var(--accent) 8%, transparent); }
.tab-content { display: none; }
.tab-content.active { display: block; }

/* Chart containers — agentsview chart-panel */
.chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
@media (max-width: 800px) { .chart-grid { grid-template-columns: 1fr; } }
.chart-card {
  background: var(--surface); border: 1px solid var(--border-muted); border-radius: var(--radius);
  padding: 12px; min-height: 200px; display: flex; flex-direction: column;
}
.chart-card h3 { font-size: 12px; font-weight: 600; color: var(--text); margin-bottom: 8px; }
.chart-wrap { position: relative; height: 240px; flex: 1; }

/* Session tree */
.st-project { background: var(--surface); border: 1px solid var(--border-muted); border-radius: var(--radius); margin-bottom: 4px; overflow: hidden; }
.st-proj-header { display: flex; align-items: center; gap: 10px; padding: 9px 12px; cursor: pointer; user-select: none; transition: background 0.1s; }
.st-proj-header:hover { background: var(--surface2); }
.st-caret { font-size: 8px; color: var(--text-dim); transition: transform 0.2s; flex-shrink: 0; width: 10px; }
.st-project.open .st-caret { transform: rotate(90deg); }
.st-proj-name { font-size: 13px; font-weight: 600; flex-shrink: 0; }
.st-proj-meta { font-size: 11px; color: var(--text-dim); flex-shrink: 0; }
.st-proj-stats { display: flex; align-items: center; gap: 5px; margin-left: auto; flex-wrap: wrap; }
.st-stat { font-size: 10px; font-weight: 500; padding: 1px 6px; border-radius: 3px; background: var(--surface2); color: var(--text-sec); }
.st-sessions { border-top: 1px solid var(--border-muted); }
.st-sessions .s-card { border-radius: 0; border: none; border-bottom: 1px solid var(--border-muted); }
.st-sessions .s-card:last-child { border-bottom: none; }
.st-more { padding: 8px 12px 8px 24px; font-size: 11px; color: var(--accent); cursor: pointer; border-top: 1px solid var(--border-muted); }
.st-more:hover { background: var(--surface2); }
.skill-legend-row { padding: 1px 3px; border-radius: 3px; transition: background 0.1s; }
.skill-legend-row:hover { background: var(--surface2); }
.skill-legend-nudge { display: none; font-size: 10px; color: var(--text-dim); padding: 3px 13px 2px; line-height: 1.4; }
.skill-legend-row.open .skill-legend-nudge { display: block; }

/* Project health table */
.health-table-wrap {
  background: var(--surface); border: 1px solid var(--border-muted); border-radius: var(--radius);
  padding: 12px; margin-bottom: 16px;
}
.health-table-wrap h3 { font-size: 12px; font-weight: 600; color: var(--text); margin-bottom: 8px; }
table { width: 100%; border-collapse: collapse; font-size: 12px; }
th { text-align: left; color: var(--text-dim); font-weight: 600; padding: 6px 10px; border-bottom: 1px solid var(--border-muted); font-size: 10px; text-transform: uppercase; letter-spacing: 0.02em; cursor: pointer; transition: color 0.1s, background 0.1s; }
th:hover { color: var(--text); background: var(--surface2); }
td { padding: 6px 10px; border-bottom: 1px solid var(--border-muted); font-size: 11px; }
tr:hover td { background: var(--surface2); }
.row-amber td { background: color-mix(in srgb, var(--yellow) 6%, transparent); }
.row-red td { background: color-mix(in srgb, var(--red) 6%, transparent); }

/* Heatmap (7x24 grid) */
.heatmap { display: grid; grid-template-columns: auto repeat(24, 13px); gap: 2px; font-size: 11px; width: fit-content; }
.heatmap-label { padding: 2px 8px 2px 0; color: var(--text-dim); text-align: right; font-size: 10px; line-height: 13px; }
.heatmap-cell {
  width: 13px; height: 13px; border-radius: 2px; display: flex; align-items: center;
  justify-content: center; font-size: 9px; color: transparent; transition: all 0.15s;
}
.heatmap-cell:hover { color: var(--text); transform: scale(1.2); }
.heatmap-header { width: 13px; text-align: center; color: var(--text-dim); font-size: 9px; padding: 1px 0; }

/* GitHub-style calendar heatmap */
.cal-heatmap { overflow-x: auto; }
.cal-heatmap svg { display: block; }
.cal-heatmap .cal-month { font-size: 10px; fill: var(--text-dim); }
.cal-heatmap .cal-day-label { font-size: 10px; fill: var(--text-dim); }
.cal-heatmap .cal-cell { rx: 2; ry: 2; stroke: var(--bg); stroke-width: 1; }
.cal-heatmap .cal-cell:hover { stroke: var(--text); stroke-width: 2; }
.cal-tooltip {
  position: fixed; background: var(--surface); border: 1px solid var(--border);
  border-radius: 6px; padding: 6px 10px; font-size: 11px; color: var(--text);
  pointer-events: none; z-index: 100; white-space: nowrap;
  box-shadow: var(--shadow);
}
.cal-legend { display: flex; align-items: center; gap: 4px; font-size: 10px; color: var(--text-dim); margin-top: 8px; justify-content: flex-end; }
.cal-legend-cell { width: 10px; height: 10px; border-radius: 2px; }

/* ===== SKILLS TAB ===== */
/* Skill bar chart */
.skill-bars-header {
  display: flex; align-items: baseline; justify-content: space-between;
  margin-bottom: 12px;
}
.skill-bars-title { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-dim); }
.skill-bars-summary { font-size: 12px; color: var(--text-dim); }
.skill-bar-row {
  background: var(--surface); border: 1px solid var(--border-muted); border-radius: var(--radius);
  border-left: 3px solid transparent; padding: 10px 14px;
  margin-bottom: 4px; cursor: pointer; transition: border-color 0.15s, background 0.15s;
}
.skill-bar-row:hover { background: var(--surface2); }
.skill-bar-header { display: flex; align-items: center; gap: 12px; }
.skill-bar-name { width: 190px; font-size: 13px; font-weight: 600; flex-shrink: 0; }
.skill-bar-track {
  flex: 1; height: 8px; background: var(--surface2); border-radius: 4px;
  position: relative; overflow: hidden;
}
.skill-bar-fill { height: 100%; border-radius: 4px; position: absolute; left: 0; top: 0; transition: width 0.5s ease; }
.skill-bar-ticks { position: absolute; inset: 0; display: flex; pointer-events: none; }
.skill-bar-ticks span {
  flex: 1; border-right: 1px solid var(--bg); opacity: 0.4;
}
.skill-bar-ticks span:last-child { border-right: none; }
.skill-bar-right { display: flex; align-items: center; gap: 8px; flex-shrink: 0; min-width: 90px; justify-content: flex-end; }
.skill-bar-level { font-size: 12px; font-weight: 700; }
.skill-bar-score { font-size: 11px; color: var(--text-dim); font-variant-numeric: tabular-nums; }
.skill-bar-gap { font-size: 10px; color: var(--yellow); font-weight: 600; }
.skill-bar-detail { display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }
.skill-bar-row.expanded .skill-bar-detail { display: block; }
.skill-dim-nudge { font-size: 12px; color: var(--text-dim); line-height: 1.5; margin-bottom: 6px; }
.skill-dim-nudge strong { color: var(--yellow); font-weight: 600; }
.skill-dim-examples { font-size: 11px; }
.skill-dim-examples a {
  color: var(--accent); text-decoration: none; display: block;
  padding: 2px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.skill-dim-examples a:hover { text-decoration: underline; }
.skill-dim-examples .ex-label { color: var(--text-dim); font-size: 10px; margin-right: 4px; }

/* Session preview modal */
.session-modal-backdrop {
  display: none; position: fixed; inset: 0; background: var(--overlay);
  z-index: 1000; justify-content: center; align-items: center;
}
.session-modal-backdrop.active { display: flex; }
.session-modal {
  background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius);
  width: 90vw; max-width: 800px; max-height: 85vh; overflow-y: auto;
  padding: 0; position: relative;
  box-shadow: var(--shadow-lg);
}
.session-modal-close {
  position: absolute; top: 8px; right: 10px; width: 28px; height: 28px;
  display: flex; align-items: center; justify-content: center;
  color: var(--text-dim); font-size: 16px; border-radius: 4px;
  transition: background 0.1s, color 0.1s; z-index: 1;
}
.session-modal-close:hover { color: var(--text); background: var(--surface2); }
.session-modal h3 { font-size: 13px; font-weight: 600; line-height: 1.4; margin: 0; }
.session-modal .modal-header {
  padding: 12px 16px; border-bottom: 1px solid var(--border-muted);
  display: flex; flex-direction: column; gap: 4px;
}
.session-modal .modal-meta {
  font-size: 10px; color: var(--text-dim);
  display: flex; gap: 6px; flex-wrap: wrap; align-items: center;
}
.session-modal .modal-meta .sep { color: var(--border); }
.session-modal .modal-judgment {
  margin: 0; padding: 10px 16px; background: var(--surface);
  border-bottom: 1px solid var(--border-muted);
  font-size: 12px; color: var(--text-sec);
}
.session-modal .modal-judgment strong { font-weight: 600; color: var(--text); }
.session-modal .modal-judgment .judge-summary { color: var(--text-dim); margin-top: 4px; line-height: 1.5; }
.session-modal .modal-body { padding: 8px 0; }
.session-modal .modal-section-label {
  font-size: 10px; font-weight: 600; color: var(--text-dim); text-transform: uppercase;
  letter-spacing: 0.02em; padding: 8px 16px 4px;
}
/* Message entries — agentsview MessageContent pattern: 4px left border, role bg, role icon */
.session-modal .msg-entry {
  border-left: 4px solid var(--border); padding: 14px 20px;
  border-radius: 0 var(--radius) var(--radius) 0;
  margin: 0 8px 4px 8px;
}
.session-modal .msg-entry.msg-user { border-left-color: var(--accent); background: var(--user-bg); }
.session-modal .msg-entry.msg-assistant { border-left-color: var(--accent2); background: var(--assistant-bg); }
.session-modal .msg-entry.msg-tool { border-left-color: var(--amber); background: var(--tool-bg); }
.session-modal .msg-header {
  display: flex; align-items: center; gap: 8px; margin-bottom: 10px;
}
.session-modal .msg-role-icon {
  width: 22px; height: 22px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 11px; font-weight: 700; color: white; flex-shrink: 0; line-height: 1;
}
.session-modal .msg-role {
  font-size: 13px; font-weight: 600; letter-spacing: 0.01em;
}
.session-modal .msg-role.role-user { color: var(--accent); }
.session-modal .msg-role.role-assistant { color: var(--accent2); }
.session-modal .msg-turn { font-size: 12px; color: var(--text-dim); margin-left: auto; }
.session-modal .msg-tools {
  font-family: var(--font-mono); font-size: 11px; color: var(--text-dim); margin-top: 4px;
  display: flex; flex-wrap: wrap; gap: 3px;
}
.session-modal .msg-tools span {
  display: inline-block; padding: 2px 6px; border-radius: 4px;
  background: var(--inset); border: 1px solid var(--border-muted); color: var(--text-sec);
}
.session-modal .msg-text {
  font-size: 14px; color: var(--text); line-height: 1.7;
  white-space: pre-wrap; max-height: 200px; overflow-y: auto;
  word-break: break-word;
}
.session-modal .msg-error {
  font-size: 11px; color: var(--red); font-weight: 500; margin-top: 4px;
}

.nudge-cards { display: flex; flex-direction: column; gap: 6px; margin-bottom: 16px; }
.nudge-card {
  background: var(--surface); border: 1px solid var(--border-muted); border-radius: var(--radius);
  padding: 10px 12px; border-left: 3px solid var(--yellow);
}
.nudge-card .nudge-header {
  display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px;
}
.nudge-card .nudge-dim {
  font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px;
}
.nudge-card .nudge-level { font-size: 11px; color: var(--text-dim); }
.nudge-card .nudge-text { font-size: 13px; color: var(--text-dim); line-height: 1.5; }
.nudge-card .nudge-dismiss {
  font-size: 11px; color: var(--text-dim); cursor: pointer; margin-top: 4px;
  display: inline-block;
}
.nudge-card .nudge-dismiss:hover { color: var(--text); }

/* Skill badges in session detail */
.skill-badges { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 10px; }
.skill-badge {
  display: inline-flex; align-items: center; gap: 3px; padding: 2px 7px;
  border-radius: 4px; font-size: 10px; font-weight: 600;
  background: color-mix(in srgb, var(--accent) 10%, transparent); color: var(--accent2);
}
.skill-badge.has-gap { background: color-mix(in srgb, var(--yellow) 10%, transparent); color: var(--yellow); }

/* Loading (deduplicated) */

/* Empty state */
.empty-state { text-align: center; padding: 32px; color: var(--text-dim); font-size: 14px; }

/* ===== SECTION NAV (jump links) ===== */
.section-nav {
  display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 12px;
  padding: 6px 0; border-bottom: 1px solid var(--border-muted);
}
.section-nav a {
  font-size: 10px; font-weight: 600; text-transform: uppercase;
  letter-spacing: 0.02em; padding: 3px 8px; border-radius: 4px;
  color: var(--text-dim); text-decoration: none; transition: all 0.12s;
  white-space: nowrap;
}
.section-nav a:hover { background: var(--surface2); color: var(--text); text-decoration: none; }
.section-nav a.nav-active { color: var(--accent); background: color-mix(in srgb, var(--accent) 8%, transparent); }

/* ===== NARRATIVE SECTIONS ===== */
.narrative-section {
  background: var(--surface); border: 1px solid var(--border-muted); border-radius: var(--radius);
  padding: 0; margin-bottom: 16px; overflow: hidden;
}
.narrative-section .ns-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 16px; cursor: pointer; transition: background 0.1s;
}
.narrative-section .ns-header:hover { background: var(--surface2); }
.narrative-section .ns-header h2 {
  font-size: 12px; font-weight: 700; margin: 0;
  text-transform: uppercase; letter-spacing: 0.03em;
}
.narrative-section .ns-toggle { color: var(--text-dim); font-size: 11px; transition: transform 0.2s; }
.narrative-section .ns-body { padding: 0 16px 16px; }
.narrative-section.collapsed .ns-body { display: none; }
.narrative-section.collapsed .ns-toggle { transform: rotate(-90deg); }
.narrative-section .prose {
  font-size: 14px; line-height: 1.7; color: var(--text-sec);
}
.narrative-section .prose p { margin-bottom: 12px; }
.narrative-section .prose strong { color: var(--text); font-weight: 600; }

/* At a Glance — amber gradient */
.at-a-glance {
  background: linear-gradient(135deg, color-mix(in srgb, var(--amber) 8%, var(--surface)), var(--surface));
  border-color: color-mix(in srgb, var(--amber) 20%, var(--border-muted));
}
.at-a-glance .ns-header h2 { color: var(--amber); }
.at-a-glance .glance-grid {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px;
}
@media (max-width: 600px) { .at-a-glance .glance-grid { grid-template-columns: 1fr; } }
.at-a-glance .glance-item h3 {
  font-size: 11px; font-weight: 700; color: var(--text-dim);
  text-transform: uppercase; letter-spacing: 0.02em; margin-bottom: 4px;
}
.at-a-glance .glance-item p {
  font-size: 13px; color: var(--text-sec); line-height: 1.6;
}

/* Win/Friction cards */
.win-card, .friction-card, .claude-md-card, .highlight-card {
  background: var(--surface); border: 1px solid var(--border-muted); border-radius: var(--radius);
  padding: 12px 16px; margin-bottom: 8px;
}
.win-card { border-left: 3px solid var(--green); }
.win-card h3 { font-size: 13px; font-weight: 600; color: var(--green); margin-bottom: 4px; }
.win-card p { font-size: 12px; color: var(--text-sec); line-height: 1.6; }

.friction-card { border-left: 3px solid var(--red); }
.friction-card h3 { font-size: 13px; font-weight: 600; color: var(--red); margin-bottom: 4px; }
.friction-card p { font-size: 12px; color: var(--text-sec); line-height: 1.6; }
.friction-card .examples {
  margin-top: 6px; font-size: 11px; color: var(--text-dim);
  font-style: italic;
}

@media (max-width: 700px) {
  #wins-friction-row > div { grid-template-columns: 1fr !important; }
}

.claude-md-card { border-left: 3px solid var(--blue); position: relative; }
.claude-md-card h3 { font-size: 13px; font-weight: 600; color: var(--blue); margin-bottom: 4px; }
.claude-md-card .rule-text {
  font-family: var(--font-mono); font-size: 12px; color: var(--text);
  padding: 8px 10px; background: var(--inset); border-radius: 4px;
  margin: 6px 0; line-height: 1.5; cursor: text;
  user-select: all;
}
.claude-md-card .rationale { font-size: 11px; color: var(--text-dim); line-height: 1.5; }
.claude-md-card .evidence { font-size: 10px; color: var(--text-dim); margin-top: 4px; font-style: italic; }
.copy-btn {
  position: absolute; top: 10px; right: 10px;
  padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 500;
  background: color-mix(in srgb, var(--blue) 12%, transparent);
  color: var(--blue); border: 1px solid color-mix(in srgb, var(--blue) 25%, transparent);
  cursor: pointer; transition: background 0.15s;
}
.copy-btn:hover { background: color-mix(in srgb, var(--blue) 20%, transparent); }
.copy-btn.copied { background: color-mix(in srgb, var(--green) 15%, transparent); color: var(--green); border-color: color-mix(in srgb, var(--green) 25%, transparent); }

/* Highlight cards grid */
#highlights-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 8px; }
#highlights-container .highlight-card { margin-bottom: 0; }
#claude-md-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 8px; }
#claude-md-container .claude-md-card { margin-bottom: 0; }

/* Highlight cards */
.highlight-card { border-left: 3px solid var(--purple); }
.highlight-card .hl-type {
  font-size: 9px; font-weight: 700; color: var(--purple);
  text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 4px;
}
.highlight-card h3 { font-size: 13px; font-weight: 600; color: var(--text); margin-bottom: 4px; }
.highlight-card .hl-narrative { font-size: 12px; color: var(--text-sec); line-height: 1.6; }
.highlight-card .hl-meta { font-size: 10px; color: var(--text-dim); margin-top: 6px; }
.highlight-card .hl-link {
  font-size: 11px; color: var(--accent); cursor: pointer; margin-top: 4px;
  display: inline-block;
}
.highlight-card .hl-link:hover { text-decoration: underline; }

/* User quote */
.user-quote {
  border-left: 3px solid var(--accent2); padding: 8px 14px; margin: 8px 0;
  background: color-mix(in srgb, var(--accent2) 5%, transparent);
  font-size: 13px; font-style: italic; color: var(--text-sec); line-height: 1.6;
  border-radius: 0 var(--radius) var(--radius) 0;
}

/* Fun headline */
.fun-headline {
  text-align: center; padding: 20px; margin-bottom: 16px;
  background: linear-gradient(135deg, color-mix(in srgb, var(--accent2) 6%, var(--surface)), color-mix(in srgb, var(--accent) 6%, var(--surface)));
  border: 1px solid var(--border-muted); border-radius: var(--radius);
  font-size: 16px; font-weight: 600; color: var(--text); line-height: 1.4;
}

/* Collapsible panel */
.collapsible-panel {
  background: var(--surface); border: 1px solid var(--border-muted); border-radius: var(--radius);
  margin-bottom: 16px; overflow: hidden;
}
.collapsible-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 14px; cursor: pointer; transition: background 0.1s;
}
.collapsible-header:hover { background: var(--surface2); }
.collapsible-header h2 {
  font-size: 12px; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.03em; color: var(--text-dim); margin: 0;
}
.collapsible-header .toggle-icon { color: var(--text-dim); font-size: 12px; transition: transform 0.2s; }
.collapsible-body { display: none; }
.collapsible-panel.open .collapsible-body { display: block; }
.collapsible-panel.open .toggle-icon { transform: rotate(90deg); }

/* Narrative in session detail */
.s-detail .narrative-block { margin-bottom: 10px; }
.s-detail .narrative-block .narrative-text {
  font-size: 12px; color: var(--text-sec); line-height: 1.65;
}
.s-detail .worked-failed { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
@media (max-width: 600px) { .s-detail .worked-failed { grid-template-columns: 1fr; } }
.s-detail .wf-card {
  padding: 8px 10px; border-radius: 4px; font-size: 11px; line-height: 1.5;
}
.s-detail .wf-card.wf-good {
  background: color-mix(in srgb, var(--green) 6%, transparent);
  border-left: 2px solid var(--green); color: var(--text-sec);
}
.s-detail .wf-card.wf-bad {
  background: color-mix(in srgb, var(--red) 6%, transparent);
  border-left: 2px solid var(--red); color: var(--text-sec);
}
.s-detail .cmd-suggestion {
  background: color-mix(in srgb, var(--blue) 6%, transparent);
  border-left: 2px solid var(--blue); padding: 8px 10px; border-radius: 0 4px 4px 0;
  margin-bottom: 10px; font-size: 11px;
}
.s-detail .cmd-suggestion .cmd-rule {
  font-family: var(--font-mono); font-size: 11px; color: var(--text); margin-bottom: 4px;
}
.s-detail .cmd-suggestion .cmd-rationale { color: var(--text-dim); line-height: 1.5; }

/* ===== SEARCH RESULTS ===== */
.search-panel {
  position: fixed; top: auto; right: 16px; width: min(520px, calc(100vw - 32px));
  max-height: 420px; overflow-y: auto; z-index: 200;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius); box-shadow: var(--shadow-lg);
  display: none;
}
.search-panel.open { display: block; }
.search-result {
  display: flex; gap: 8px; padding: 8px 12px; cursor: pointer;
  border-bottom: 1px solid var(--border-muted); transition: background 0.1s;
  align-items: flex-start;
}
.search-result:last-child { border-bottom: none; }
.search-result:hover { background: var(--surface2); }
.search-result .sr-role {
  width: 18px; height: 18px; border-radius: 50%; flex-shrink: 0; margin-top: 2px;
  display: flex; align-items: center; justify-content: center;
  font-size: 9px; font-weight: 700; color: white;
}
.search-result .sr-body { flex: 1; min-width: 0; }
.search-result .sr-snippet {
  font-size: 12px; color: var(--text-sec); line-height: 1.5;
  overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}
.search-result .sr-snippet mark {
  background: color-mix(in srgb, var(--amber) 30%, transparent);
  color: var(--text); border-radius: 2px; padding: 0 2px;
}
.search-result .sr-meta {
  font-size: 10px; color: var(--text-dim); margin-top: 2px;
}
.search-empty { padding: 20px; text-align: center; color: var(--text-dim); font-size: 12px; }

/* ===== IMPROVED MESSAGE RENDERER ===== */
.msg-text code {
  font-family: var(--font-mono); font-size: 0.85em;
  background: var(--inset); border: 1px solid var(--border-muted);
  border-radius: 4px; padding: 0.15em 0.4em;
}
.msg-text pre {
  background: var(--inset); border: 1px solid var(--border-muted);
  border-radius: 4px; padding: 10px 12px; margin: 8px 0;
  overflow-x: auto; font-family: var(--font-mono); font-size: 12px;
  line-height: 1.5; color: var(--text);
}
.msg-text pre code {
  background: none; border: none; padding: 0; font-size: inherit;
}
.msg-text strong { font-weight: 600; color: var(--text); }
.msg-text em { font-style: italic; }
.msg-text a { color: var(--accent); }
.msg-text ul, .msg-text ol { margin: 6px 0 6px 20px; }
.msg-text li { margin-bottom: 4px; }
.msg-text h1, .msg-text h2, .msg-text h3 {
  font-weight: 600; color: var(--text); margin: 12px 0 6px;
}
.msg-text h1 { font-size: 16px; }
.msg-text h2 { font-size: 14px; }
.msg-text h3 { font-size: 13px; }
.msg-text blockquote {
  border-left: 3px solid var(--border); padding: 4px 12px; margin: 6px 0;
  color: var(--text-dim);
}
.msg-expand-btn {
  font-size: 11px; color: var(--accent); cursor: pointer; margin-top: 4px;
  display: inline-block;
}
.msg-expand-btn:hover { text-decoration: underline; }
.msg-text.collapsed { max-height: 200px; overflow: hidden; position: relative; }
.msg-text.collapsed::after {
  content: ''; position: absolute; bottom: 0; left: 0; right: 0;
  height: 40px; background: linear-gradient(transparent, var(--bg));
  pointer-events: none;
}

/* ===== SKILL EXAMPLE CARDS ===== */
.skill-example-cards { display: flex; flex-direction: column; gap: 4px; margin-top: 6px; }
.skill-example-card {
  display: flex; align-items: center; gap: 8px; padding: 6px 8px;
  background: var(--inset); border-radius: 4px; cursor: pointer;
  transition: background 0.1s; border: 1px solid transparent;
}
.skill-example-card:hover { background: var(--surface2); border-color: var(--border-muted); }
.skill-example-card .ex-outcome {
  width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0;
}
.skill-example-card .ex-info { flex: 1; min-width: 0; }
.skill-example-card .ex-prompt {
  font-size: 11px; color: var(--text); white-space: nowrap;
  overflow: hidden; text-overflow: ellipsis;
}
.skill-example-card .ex-meta {
  font-size: 10px; color: var(--text-dim);
}
.skill-example-card .ex-level-badge {
  font-size: 9px; font-weight: 600; padding: 1px 5px; border-radius: 3px;
  flex-shrink: 0;
}

/* Footer — agentsview StatusBar style */
.footer {
  margin-top: 24px; padding: 8px 0; border-top: 1px solid var(--border);
  text-align: center; font-size: 10px; color: var(--text-dim);
  letter-spacing: 0.01em;
}
.footer a { color: var(--accent); text-decoration: none; }
.footer a:hover { text-decoration: underline; }
</style>
</head>
<body>

<!-- Loading overlay removed — progress shown inline via refresh-progress bar -->

<div class="page">

  <!-- Top bar — agentsview AppHeader pattern -->
  <div class="top-bar">
    <h1>Claude <span>Retro</span></h1>
    <div style="display:flex;align-items:center;gap:2px;margin-left:auto">
      <button id="theme-toggle" onclick="toggleTheme()" style="width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:4px;color:var(--text-dim);font-size:14px;transition:background 0.12s,color 0.12s;line-height:1" title="Toggle theme"></button>
      <select id="concurrency-select" style="height:26px;padding:0 8px;background:var(--inset);border:1px solid var(--border-muted);border-radius:4px;color:var(--text-sec);font-size:11px;outline:none;cursor:pointer;transition:border-color 0.15s" title="Parallelism">
        <option value="4">4x</option>
        <option value="8">8x</option>
        <option value="12" selected>12x</option>
        <option value="16">16x</option>
        <option value="24">24x</option>
      </select>
      <button class="refresh-btn" id="refresh-btn" onclick="refreshData()">Run Judge</button>
      <a href="/api/export" download style="height:24px;padding:0 8px;border-radius:4px;font-size:11px;font-weight:500;color:var(--text-dim);text-decoration:none;display:inline-flex;align-items:center;transition:background 0.1s,color 0.1s" onmouseover="this.style.background='var(--surface2)';this.style.color='var(--text-sec)'" onmouseout="this.style.background='';this.style.color='var(--text-dim)'">Export</a>
    </div>
    <div id="refresh-bar" style="position:absolute;bottom:-1px;left:0;height:2px;width:0%;background:var(--accent);transition:width 0.3s"></div>
  </div>

  <!-- Progress -->
  <div id="refresh-progress" style="display:none;position:fixed;top:8px;right:16px;background:var(--surface);border:1px solid var(--border-muted);border-radius:var(--radius);padding:6px 10px;font-size:11px;color:var(--text-dim);z-index:1000;box-shadow:var(--shadow-md);transition:background-color 0.3s,border-color 0.3s">
    <div style="display:flex;gap:8px;align-items:center">
      <span id="refresh-step"></span>
      <span id="refresh-count" style="color:var(--accent);font-weight:500"></span>
    </div>
  </div>

  <!-- 1. THE VERDICT -->
  <div class="verdict" id="verdict">
    <!-- Content loaded by JS -->
  </div>

  <!-- Section nav — jump links that appear when synthesis exists -->
  <nav class="section-nav" id="section-nav" style="display:none">
    <a href="#at-a-glance" onclick="scrollToSection(event,'at-a-glance')">Glance</a>
    <a href="#changes-section" onclick="scrollToSection(event,'changes-section')">Actions</a>
    <a href="#usage-narrative-section" onclick="scrollToSection(event,'usage-narrative-section')">Profile</a>
    <a href="#wins-section" onclick="scrollToSection(event,'wins-section')">Wins</a>
    <a href="#friction-section" onclick="scrollToSection(event,'friction-section')">Friction</a>
    <a href="#claude-md-section" onclick="scrollToSection(event,'claude-md-section')">CLAUDE.md</a>
    <a href="#highlights-section" onclick="scrollToSection(event,'highlights-section')">Highlights</a>
    <a href="#activity-section" onclick="scrollToSection(event,'activity-section')">Activity</a>
    <a href="#tab-sessions" onclick="scrollToSection(event,'tab-sessions');switchTab('sessions')">Sessions</a>
  </nav>

  <!-- Skill nudges (shown below verdict if any active nudges) -->
  <div id="skill-nudges-section" style="display:none"></div>

  <!-- 2. AT A GLANCE (from synthesis) — collapsible -->
  <div class="narrative-section at-a-glance" id="at-a-glance" style="display:none">
    <div class="ns-header" onclick="this.parentElement.classList.toggle('collapsed')">
      <h2>At a Glance</h2>
      <span class="ns-toggle">&#9660;</span>
    </div>
    <div class="ns-body">
      <div class="glance-grid" id="glance-grid"></div>
    </div>
  </div>

  <!-- 3. CHANGE THESE 3 THINGS -->
  <div id="changes-section" style="display:none">
    <div class="section-label">Change These 3 Things</div>
    <div class="change-cards" id="change-cards"></div>
  </div>

  <!-- 4. USAGE NARRATIVE — starts expanded -->
  <div class="narrative-section" id="usage-narrative-section" style="display:none">
    <div class="ns-header" onclick="this.parentElement.classList.toggle('collapsed')">
      <h2 style="color:var(--accent2)">How You Work</h2>
      <span class="ns-toggle">&#9660;</span>
    </div>
    <div class="ns-body">
      <div class="prose" id="usage-narrative"></div>
    </div>
  </div>

  <!-- 5/6 WINS + FRICTION — side by side on wide screens -->
  <div id="wins-friction-row" style="display:none;margin-bottom:16px">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div id="wins-section">
        <div class="section-label" style="color:var(--green)">What Went Well</div>
        <div id="wins-container"></div>
      </div>
      <div id="friction-section">
        <div class="section-label" style="color:var(--red)">Top Friction Points</div>
        <div id="friction-container"></div>
      </div>
    </div>
  </div>

  <!-- 7. CLAUDE.md SUGGESTIONS (auto-applied) -->
  <div id="claude-md-section" style="display:none">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <div class="section-label" style="color:var(--blue);margin-bottom:0">CLAUDE.md Suggestions</div>
      <span id="claude-md-status" style="font-size:10px;color:var(--green);font-weight:500"></span>
    </div>
    <div style="font-size:11px;color:var(--text-dim);margin-bottom:10px">These rules are automatically added to each project's CLAUDE.md after judging.</div>
    <div id="claude-md-container"></div>
  </div>

  <!-- 8. SESSION HIGHLIGHTS — starts collapsed -->
  <div class="narrative-section collapsed" id="highlights-section" style="display:none">
    <div class="ns-header" onclick="this.parentElement.classList.toggle('collapsed')">
      <h2 style="color:var(--purple)">Session Highlights</h2>
      <span class="ns-toggle">&#9660;</span>
    </div>
    <div class="ns-body" id="highlights-container"></div>
  </div>

  <!-- 9. FUN HEADLINE -->
  <div class="fun-headline" id="fun-headline" style="display:none"></div>

  <!-- 10. ACTIVITY CHARTS (always visible) -->
  <div id="activity-section">
    <div class="section-label">Activity</div>
    <div style="display:grid; grid-template-columns: 1fr auto; gap: 12px; align-items: start; margin-bottom:12px">
      <div class="chart-card">
        <h3>Contribution Calendar</h3>
        <div id="calendar-container" class="cal-heatmap"></div>
      </div>
      <div class="chart-card">
        <h3>Activity by Day &amp; Hour</h3>
        <div id="heatmap-container"></div>
      </div>
    </div>
    <div class="chart-card" style="margin-bottom:12px">
      <h3>Productivity Trend</h3><div class="chart-wrap"><canvas id="chart-trends"></canvas></div>
    </div>
  </div>

  <!-- TAB BAR -->
  <div class="tab-bar">
    <button class="tab-btn active" data-tab="sessions" onclick="switchTab('sessions')">Sessions</button>
  </div>

  <!-- TAB: Sessions -->
  <div class="tab-content active" id="tab-sessions">
    <div class="feed-header">
      <div class="filter-bar">
        <!-- Hidden inputs kept for backward compat with existing filter logic -->
        <select id="filter-project" style="display:none"><option value="">All Projects</option></select>
        <select id="filter-sort" style="display:none">
          <option value="started_at DESC">Newest</option>
          <option value="started_at ASC">Oldest</option>
          <option value="productivity ASC">Lowest productivity</option>
          <option value="misalignments DESC">Most misalignments</option>
          <option value="duration DESC">Longest</option>
          <option value="turns DESC">Most turns</option>
        </select>
        <select id="tree-sort">
          <option value="sessions">Sessions ↓</option>
          <option value="productivity">Productivity ↓</option>
          <option value="completion">Completion ↓</option>
          <option value="name">Name A–Z</option>
        </select>
        <div style="position:relative">
          <input type="text" id="filter-search" placeholder="Search all sessions..." style="min-width:220px" autocomplete="off">
          <div class="search-panel" id="search-panel"></div>
        </div>
      </div>
    </div>
    <!-- Project tree (default view) -->
    <div id="session-tree"></div>
    <!-- Flat list (shown when search/filter active) -->
    <div id="session-feed-wrap" style="display:none">
      <div style="background:var(--surface);border:1px solid var(--border-muted);border-radius:var(--radius);overflow:hidden">
        <div class="session-feed" id="session-feed"></div>
        <div class="load-more" id="load-more" style="display:none" onclick="loadMoreSessions()"><span>Load more sessions</span></div>
      </div>
    </div>
  </div>


  <!-- Footer -->
  <div class="footer">
    Claude Retro <span id="version-info">loading...</span>
  </div>

</div>

<!-- Session preview modal -->
<div class="session-modal-backdrop" id="session-modal" onclick="if(event.target===this)closeSessionModal()">
  <div class="session-modal">
    <button class="session-modal-close" onclick="closeSessionModal()">&times;</button>
    <div id="session-modal-content"><div class="loading"><span class="spinner"></span></div></div>
  </div>
</div>

<script>
// ===== STATE =====
let charts = {};
let sessionOffset = 0;
const PAGE_SIZE = 30;
let allSessionsLoaded = false;
let expandedSessionId = null;

// ===== THEME =====
function getPreferredTheme() {
  const stored = localStorage.getItem('claude-retro-theme');
  if (stored) return stored;
  return window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
}

function applyTheme(theme) {
  if (theme === 'light') {
    document.documentElement.setAttribute('data-theme', 'light');
  } else {
    document.documentElement.removeAttribute('data-theme');
  }
  const btn = document.getElementById('theme-toggle');
  if (btn) btn.textContent = theme === 'light' ? '\u263E' : '\u2600';
}

function toggleTheme() {
  const current = document.documentElement.hasAttribute('data-theme') ? 'light' : 'dark';
  const next = current === 'dark' ? 'light' : 'dark';
  localStorage.setItem('claude-retro-theme', next);
  applyTheme(next);
  // Re-render charts with new theme colors
  reRenderChartsForTheme();
}

// Apply theme immediately (before DOM loads) to avoid flash
applyTheme(getPreferredTheme());

function getCSSVar(name) {
  return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
}

function reRenderChartsForTheme() {
  loadCharts();
  loadSkills();
}

// ===== HELPERS =====
async function api(path) { const r = await fetch(path); return r.json(); }

function fmtDuration(s) {
  if (!s) return '0m';
  if (s < 60) return s + 's';
  if (s < 3600) return Math.round(s / 60) + 'm';
  return (s / 3600).toFixed(1) + 'h';
}
function fmtPct(v) { return v != null ? (v * 100).toFixed(0) + '%' : '-'; }
function fmtTokens(t) {
  if (!t) return '0';
  if (t < 1000) return t.toString();
  if (t < 1000000) return (t / 1000).toFixed(1) + 'k';
  return (t / 1000000).toFixed(1) + 'M';
}
function fmtDate(d) {
  if (!d) return '';
  return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
}
function truncate(s, n) { return s && s.length > n ? s.slice(0, n) + '...' : (s || ''); }
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function shortProject(name) { return (name || '').replace(/-Users-npow-code-/g, '').replace(/-Users-npow-/g, ''); }
function destroyChart(key) { if (charts[key]) { charts[key].destroy(); delete charts[key]; } }

// Simple markdown renderer for message content
function renderMd(text) {
  if (!text) return '';
  // Escape HTML first
  let s = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  // Code blocks (``` ... ```)
  s = s.replace(/```(\w*)\n([\s\S]*?)```/g, (_, lang, code) =>
    `<pre><code>${code}</code></pre>`
  );
  // Inline code
  s = s.replace(/`([^`\n]+)`/g, '<code>$1</code>');
  // Bold (process before italic)
  s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  // Italic (only match single * not preceded/followed by *)
  s = s.replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g, '<em>$1</em>');
  // Headers
  s = s.replace(/^### (.+)$/gm, '<h3>$1</h3>');
  s = s.replace(/^## (.+)$/gm, '<h2>$1</h2>');
  s = s.replace(/^# (.+)$/gm, '<h1>$1</h1>');
  // Blockquotes
  s = s.replace(/^&gt; (.+)$/gm, '<blockquote>$1</blockquote>');
  // Unordered lists
  s = s.replace(/^- (.+)$/gm, '<li>$1</li>');
  s = s.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
  // Line breaks (but not inside pre)
  s = s.replace(/\n/g, '<br>');
  // Clean up <br> inside <pre>
  s = s.replace(/<pre>([\s\S]*?)<\/pre>/g, (m) => m.replace(/<br>/g, '\n'));
  return s;
}

// Render message with collapsible long content
function renderMessage(text, maxLen) {
  maxLen = maxLen || 800;
  const rendered = renderMd(text);
  const isLong = text.length > maxLen;
  const id = 'msg-' + Math.random().toString(36).slice(2, 8);
  if (isLong) {
    return `<div class="msg-text collapsed" id="${id}">${rendered}</div>
      <span class="msg-expand-btn" onclick="document.getElementById('${id}').classList.toggle('collapsed'); this.textContent = this.textContent === 'Show more' ? 'Show less' : 'Show more'">Show more</span>`;
  }
  return `<div class="msg-text">${rendered}</div>`;
}

function outcomeBadge(o) { return o ? `<span class="badge badge-${o}">${(o || '').replace('_', ' ')}</span>` : ''; }
function intentBadge(i) { return i ? `<span class="badge badge-${i}">${i}</span>` : ''; }
function trajectoryBadge(t) { return t ? `<span class="badge badge-${t}">${t}</span>` : ''; }

function outcomeColor(outcome) {
  switch (outcome) {
    case 'completed': return 'var(--green)';
    case 'partially_completed': return 'var(--yellow)';
    case 'failed': return 'var(--red)';
    case 'exploratory': return 'var(--cyan)';
    default: return 'var(--text-dim)';
  }
}
function outcomeIcon(outcome) {
  return '';
}

function prodColor(v) {
  if (v == null) return 'var(--text-dim)';
  if (v >= 0.7) return 'var(--green)';
  if (v >= 0.4) return 'var(--yellow)';
  return 'var(--red)';
}


// ===== 1. THE VERDICT =====
async function loadVerdict() {
  const [overview, jStats, patterns] = await Promise.all([
    api('/api/overview'), api('/api/judgments/stats'), api('/api/patterns')
  ]);

  const el = document.getElementById('verdict');

  const unjudged = overview.total_sessions - jStats.total_judged;

  // Stat cards builder
  function statCard(value, label, sub) {
    return `<div class="stat-card"><div class="stat-value">${value}</div><div class="stat-label">${label}</div>${sub ? `<div class="stat-sub">${sub}</div>` : ''}</div>`;
  }

  if (jStats.total_judged === 0) {
    // No judgments yet — show basic stats
    el.innerHTML = `
      <div class="verdict-summary">
        <strong>${overview.total_sessions}</strong> sessions across <strong>${overview.total_projects}</strong> projects.
        ${overview.total_hours}h total. Run the LLM Judge to get AI analysis.
      </div>
      <div class="stat-cards">
        ${statCard(overview.total_sessions, 'Sessions')}
        ${statCard(overview.total_hours + 'h', 'Total Time')}
        ${statCard(overview.avg_turns, 'Avg Turns')}
        ${statCard(fmtTokens(overview.total_messages), 'Messages')}
        ${statCard(overview.active_days, 'Active Days')}
        ${statCard(overview.msgs_per_session_avg, 'Msgs/Session', 'med ' + overview.msgs_per_session_median)}
      </div>`;
    return;
  }

  const od = jStats.outcome_distribution || {};
  const completed = od.completed || 0;
  const partial = od.partially_completed || 0;
  const failed = od.failed || 0;
  const total = jStats.total_judged;
  const completionRate = total > 0 ? ((completed + partial) / total) : 0;
  const prodPct = jStats.avg_productivity || 0;
  const wastePct = 1 - prodPct;

  // Build the summary sentence
  let summaryParts = [];
  summaryParts.push(`<strong>${total}</strong> of ${overview.total_sessions} sessions analyzed.`);
  summaryParts.push(`<strong>${fmtPct(completionRate)}</strong> completed or partially completed.`);

  // Top issue from prompt gaps
  const topGap = patterns.prompt_gaps.length > 0 ? patterns.prompt_gaps[0] : null;
  const topTheme = patterns.misalignment_themes.length > 0 ? patterns.misalignment_themes[0] : null;

  if (topGap && topGap.count >= 2) {
    summaryParts.push(`Your biggest gap: underspecifying <strong>${topGap.category}</strong> (${topGap.count} occurrences).`);
  } else if (topTheme && topTheme.count >= 2) {
    summaryParts.push(`Top misalignment pattern: <strong>${topTheme.theme}</strong> (${topTheme.count} times).`);
  }

  el.innerHTML = `
    <div class="verdict-summary">${summaryParts.join(' ')}</div>
    <div class="verdict-bar-wrap">
      <div class="verdict-bar">
        <div class="productive" style="width:${(prodPct * 100).toFixed(0)}%"></div>
        <div class="waste" style="width:${(wastePct * 100).toFixed(0)}%"></div>
      </div>
      <div class="verdict-bar-labels">
        <span>${fmtPct(prodPct)} productive</span>
        <span>${fmtPct(wastePct)} waste</span>
      </div>
    </div>
    <div class="stat-cards">
      ${statCard(overview.total_sessions, 'Sessions', unjudged > 0 ? unjudged + ' unjudged' : '')}
      ${statCard(completed, 'Completed', partial + ' partial, ' + failed + ' failed')}
      ${statCard(fmtPct(prodPct), 'Productivity')}
      ${overview.estimated_cost_usd > 0 ? statCard('~$' + overview.estimated_cost_usd.toFixed(2), 'Est. Cost', fmtTokens(overview.total_input_tokens + overview.total_output_tokens) + ' tokens') : ''}
      ${statCard(fmtTokens(overview.total_tool_calls || 0), 'Tool Calls')}
      ${statCard(overview.active_days, 'Active Days')}
    </div>
    <div style="display:flex;gap:16px;align-items:center;margin-top:8px;padding-top:8px;border-top:1px solid var(--border-muted)">
      <div id="skill-radar-wrap" style="flex-shrink:0"></div>
      <div id="skill-legend-wrap" style="flex:1;display:grid;grid-template-columns:repeat(3,1fr);gap:6px;align-self:stretch;align-content:stretch"></div>
    </div>`;

  // Store for use by change cards
  window._patterns = patterns;
  window._jStats = jStats;
  window._overview = overview;
}

// Parse structured metrics out of a _project_flags diagnosis string
// e.g. "Productivity 61% vs 78% avg; 5.5 misalignments/session vs 2.0 avg; ..."
function parseProjectMetrics(diagnosis) {
  const metrics = [];

  // Productivity X% vs Y% avg
  const prod = diagnosis.match(/productivity\s+([\d.]+)%\s+vs\s+([\d.]+)%\s+avg/i);
  if (prod) {
    const actual = parseFloat(prod[1]);
    const avg = parseFloat(prod[2]);
    const diff = actual - avg;
    metrics.push({
      val: actual + '%',
      delta: (diff > 0 ? '+' : '') + Math.round(diff) + 'pp',
      label: 'Productivity',
      color: actual < avg * 0.85 ? 'var(--red)' : 'var(--yellow)',
      pct: actual,          // bar fill %
      avgPct: avg,          // tick position %
    });
  }

  // X misalignments/session vs Y avg
  const mis = diagnosis.match(/([\d.]+)\s+misalignments\/session\s+vs\s+([\d.]+)\s+avg/i);
  if (mis) {
    const actual = parseFloat(mis[1]);
    const avg = parseFloat(mis[2]);
    const scale = avg * 4; // bar scale: 4× avg = 100%
    metrics.push({
      val: actual + '×',
      delta: '+' + (actual - avg).toFixed(1) + '×',
      label: 'Misalign/sess',
      color: 'var(--orange)',
      pct: Math.min(100, (actual / scale) * 100),
      avgPct: Math.min(100, (avg / scale) * 100),
    });
  }

  // Completion rate: X%
  const comp = diagnosis.match(/completion rate:\s*([\d.]+)%/i);
  if (comp) {
    const actual = parseFloat(comp[1]);
    metrics.push({
      val: actual + '%',
      delta: null,
      label: 'Completion',
      color: actual < 50 ? 'var(--red)' : actual < 75 ? 'var(--yellow)' : 'var(--green)',
      pct: actual,
      avgPct: null,
    });
  }

  // Tool errors: only show if no misalignments (avoid 4-column overflow)
  if (!mis) {
    // "49 tool errors (12.2/session vs 5.9 avg)"
    const err = diagnosis.match(/\d+\s+tool errors\s+\(([\d.]+)\/session\s+vs\s+([\d.]+)\s+avg\)/i);
    if (err) {
      const sess = parseFloat(err[1]);
      const avg = parseFloat(err[2]);
      const scale = avg * 4;
      metrics.push({
        val: sess.toFixed(1) + '/s',   // per-session rate is the hero
        delta: '+' + (sess - avg).toFixed(1) + '/s',
        label: 'Errors/sess',
        color: 'var(--yellow)',
        pct: Math.min(100, (sess / scale) * 100),
        avgPct: Math.min(100, (avg / scale) * 100),
      });
    }
  }

  return metrics.slice(0, 3);
}

// ===== 2. CHANGE THESE 3 THINGS =====
async function loadChangeCards() {
  const [prescriptions, patterns, actions] = await Promise.all([
    api('/api/prescriptions'), api('/api/patterns'), api('/api/actions')
  ]);

  const section = document.getElementById('changes-section');
  const container = document.getElementById('change-cards');
  let cards = [];

  // Pull top 3 prescriptions by confidence
  const topPrescriptions = prescriptions.prescriptions.slice(0, 3);
  topPrescriptions.forEach((p, i) => {
    cards.push({
      num: i + 1,
      title: p.title,
      body: p.description,
      link: p.evidence,
    });
  });

  // If fewer than 3 prescriptions, fill from prompt gap patterns
  if (cards.length < 3 && patterns.prompt_gaps.length > 0) {
    patterns.prompt_gaps.slice(0, 3 - cards.length).forEach(g => {
      cards.push({
        num: cards.length + 1,
        title: `Specify ${g.category} upfront`,
        body: `${g.count} sessions had gaps in ${g.category}. Examples: ${g.examples.slice(0, 2).join(', ')}.`,
        link: `${(g.pct * 100).toFixed(0)}% of all prompt gaps`,
      });
    });
  }

  // If still fewer than 3, fill from actions
  if (cards.length < 3) {
    const usedTitles = new Set(cards.map(c => c.title));
    actions.actions.filter(a => !usedTitles.has(a.title)).slice(0, 3 - cards.length).forEach(a => {
      cards.push({
        num: cards.length + 1,
        title: a.title,
        body: a.body,
        link: a.evidence,
      });
    });
  }

  if (cards.length === 0) {
    section.style.display = 'none';
    return;
  }

  section.style.display = 'block';
  container.innerHTML = cards.map(c => {
    // Non-project cards: build a simple text link
    let linkHtml = '';
    if (c.link && !c.link.startsWith('project:')) {
      linkHtml = `<span style="font-size:11px;color:var(--text-dim)">${c.link}</span>`;
    }
    // Split diagnosis from advice if delimiter present
    const parts = c.body.split('||SPLIT||');
    const diagnosis = parts[0];
    const advice = parts[1] || '';

    // Project-health card: structured widget layout
    if (c.link && c.link.startsWith('project:')) {
      const linkParts = c.link.split(':');
      const projName = linkParts.slice(1, -1).join(':');
      const short = shortProject(projName);
      const metrics = parseProjectMetrics(diagnosis);
      const cols = metrics.length || 1;
      const metricsHtml = metrics.map(m => {
        const tick = m.avgPct != null
          ? `<div class="cc-metric-bar-tick" style="left:${m.avgPct}%"></div>` : '';
        const bar = m.pct != null
          ? `<div class="cc-metric-bar">
               <div class="cc-metric-bar-fill" style="width:${Math.min(100,m.pct)}%;background:${m.color}"></div>
               ${tick}
             </div>` : '';
        return `<div class="cc-metric">
          <div>
            <span class="cc-metric-val" style="color:${m.color}">${m.val}</span>
            ${m.delta ? `<span class="cc-metric-delta" style="color:${m.color}">${m.delta}</span>` : ''}
          </div>
          <div class="cc-metric-label">${m.label}</div>
          ${bar}
        </div>`;
      }).join('');
      const shortAdvice = advice ? advice.split('.').filter(Boolean).slice(0, 2).map(s => s.trim()).join('. ') + '.' : '';
      return `<div class="cc-card">
        <div class="cc-header">
          <div class="cc-project"><span class="cc-project-icon">⚠</span>${short}</div>
          <span class="cc-num">#${c.num}</span>
        </div>
        <div class="cc-metrics" style="--cols:${cols}">${metricsHtml}</div>
        ${shortAdvice ? `<div class="cc-advice"><div class="cc-advice-label">Fix</div>${shortAdvice}</div>` : ''}
        <div class="cc-footer"><span class="cc-cta" onclick="filterByProject('${projName.replace(/'/g, "\\'")}')">View ${linkParts[linkParts.length-1]} sessions &rarr;</span></div>
      </div>`;
    }

    // Generic card (non-project): simpler layout
    return `<div class="cc-card">
      <div class="cc-header">
        <div class="cc-project" style="font-size:12px">${c.title}</div>
        <span class="cc-num">#${c.num}</span>
      </div>
      <div class="cc-plain-body">${diagnosis}</div>
      ${advice ? `<div class="cc-advice"><div class="cc-advice-label">Fix</div>${advice}</div>` : ''}
      ${linkHtml ? `<div class="cc-footer">${linkHtml}</div>` : ''}
    </div>`;
  }).join('');
}

// ===== NARRATIVE SECTIONS =====
async function loadSynthesis() {
  try {
    const data = await api('/api/synthesis');
    const s = data.synthesis;
    if (!s) return;

    // At a Glance
    const glance = s.at_a_glance;
    if (glance && typeof glance === 'object') {
      const grid = document.getElementById('glance-grid');
      grid.innerHTML = `
        <div class="glance-item"><h3>What's Working</h3><p>${glance.whats_working || ''}</p></div>
        <div class="glance-item"><h3>What's Hindering</h3><p>${glance.whats_hindering || ''}</p></div>
        <div class="glance-item"><h3>Quick Wins</h3><p>${glance.quick_wins || ''}</p></div>
        <div class="glance-item"><h3>Ambitious Workflows</h3><p>${glance.ambitious_workflows || ''}</p></div>
      `;
      document.getElementById('at-a-glance').style.display = 'block';
    }

    // Usage Narrative
    if (s.usage_narrative) {
      const paragraphs = s.usage_narrative.split('\n').filter(p => p.trim());
      document.getElementById('usage-narrative').innerHTML = paragraphs.map(p => `<p>${p}</p>`).join('');
      document.getElementById('usage-narrative-section').style.display = 'block';
    }

    // Top Wins + Friction (side by side)
    const wins = s.top_wins;
    const friction = s.top_friction;
    let hasWinsOrFriction = false;

    if (wins && wins.length > 0) {
      document.getElementById('wins-container').innerHTML = wins.map(w =>
        `<div class="win-card"><h3>${w.title}</h3><p>${w.description}</p></div>`
      ).join('');
      hasWinsOrFriction = true;
    }

    if (friction && friction.length > 0) {
      document.getElementById('friction-container').innerHTML = friction.map(f => {
        const examples = (f.examples || []).map(e => e).join('; ');
        return `<div class="friction-card">
          <h3>${f.title}</h3>
          <p>${f.description}</p>
          ${examples ? `<div class="examples">${examples}</div>` : ''}
        </div>`;
      }).join('');
      hasWinsOrFriction = true;
    }

    if (hasWinsOrFriction) {
      document.getElementById('wins-friction-row').style.display = 'block';
    }

    // CLAUDE.md Additions (auto-applied to project CLAUDE.md files)
    const additions = s.claude_md_additions;
    if (additions && additions.length > 0) {
      document.getElementById('claude-md-container').innerHTML = additions.map((a, i) =>
        `<div class="claude-md-card">
          <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px">
            <span style="color:var(--green);font-size:11px;font-weight:600">AUTO-APPLIED</span>
          </div>
          <div class="rule-text" id="rule-text-${i}">${a.rule || ''}</div>
          <div class="rationale">${a.rationale || ''}</div>
          ${a.evidence ? `<div class="evidence">${a.evidence}</div>` : ''}
        </div>`
      ).join('');
      document.getElementById('claude-md-status').textContent = `${additions.length} rules auto-applied to project CLAUDE.md files`;
      document.getElementById('claude-md-section').style.display = 'block';
    }

    // Fun Headline
    if (s.fun_headline) {
      const el = document.getElementById('fun-headline');
      el.textContent = s.fun_headline;
      el.style.display = 'block';
    }

    // Show section nav when we have synthesis content
    showSectionNav();
  } catch (e) {
    console.error('Failed to load synthesis:', e);
  }
}

async function loadHighlights() {
  try {
    const data = await api('/api/session-highlights');
    const highlights = data.highlights;
    if (!highlights || highlights.length === 0) return;

    const TYPE_COLORS = {
      most_productive: 'var(--green)',
      most_wasteful: 'var(--red)',
      most_misaligned: 'var(--orange)',
      best_prompt: 'var(--blue)',
      longest_success: 'var(--purple)',
    };

    document.getElementById('highlights-container').innerHTML = highlights.map(h => {
      const color = TYPE_COLORS[h.type] || 'var(--purple)';
      const short = shortProject(h.project || '');
      const title = h.prompt_summary || '(no summary)';
      const narrative = h.narrative ? h.narrative.split('\n')[0] : (h.what_worked || h.what_failed || '');
      const narrativeHtml = narrative && narrative !== title ? `<div class="hl-narrative">${truncate(narrative, 200)}</div>` : '';
      return `<div class="highlight-card" style="border-left-color:${color}">
        <div class="hl-type" style="color:${color}">${h.label}</div>
        <h3>${title}</h3>
        ${narrativeHtml}
        <div class="hl-meta">${short} &middot; ${fmtDuration(h.duration)} &middot; ${h.outcome || ''}</div>
        <span class="hl-link" onclick="toggleSessionById('${h.session_id}', '${(h.project||'').replace(/'/g,'')}')">View session &rarr;</span>
      </div>`;
    }).join('');
    const hlSection = document.getElementById('highlights-section');
    hlSection.style.display = 'block';
    hlSection.classList.remove('collapsed'); // Show expanded since we just loaded
  } catch (e) {
    console.error('Failed to load highlights:', e);
  }
}

function toggleSessionById(sessionId, project) {
  // Switch to sessions tab and expand the session
  switchTab('sessions');
  const card = document.getElementById('scard-' + sessionId);
  if (card) {
    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
    setTimeout(() => toggleSession(sessionId, card), 300);
  } else {
    // Session not loaded yet — filter by project (if known) to narrow results, then find it
    const projSelect = document.getElementById('filter-project');
    const sortSelect = document.getElementById('filter-sort');
    const searchInput = document.getElementById('filter-search');
    // Set project filter to the session's project to minimize loaded sessions
    if (projSelect && project) {
      projSelect.value = project; // option values are raw project names
    } else if (projSelect) {
      projSelect.value = '';
    }
    if (sortSelect) sortSelect.value = 'started_at DESC';
    if (searchInput) searchInput.value = '';
    expandedSessionId = null;
    loadSessions(false).then(() => {
      setTimeout(() => {
        const c = document.getElementById('scard-' + sessionId);
        if (c) {
          c.scrollIntoView({ behavior: 'smooth', block: 'center' });
          setTimeout(() => toggleSession(sessionId, c), 300);
        }
      }, 400);
    });
  }
}

function scrollToSection(event, id) {
  event.preventDefault();
  const el = document.getElementById(id);
  if (el) {
    // Uncollapse if collapsed
    if (el.classList.contains('collapsed')) el.classList.remove('collapsed');
    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

function showSectionNav() {
  document.getElementById('section-nav').style.display = 'flex';
}

function copyRule(btn, index) {
  const el = document.getElementById('rule-text-' + index);
  if (!el) return;
  navigator.clipboard.writeText(el.textContent.trim()).then(() => {
    btn.textContent = 'Copied!';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
  });
}

function copyAllRules() {
  const ruleEls = document.querySelectorAll('[id^="rule-text-"]');
  const rules = Array.from(ruleEls).map(el => el.textContent.trim()).filter(Boolean);
  if (rules.length === 0) return;
  const text = '# Claude Retro Suggestions\n\n' + rules.join('\n');
  const btn = document.getElementById('copy-all-rules');
  navigator.clipboard.writeText(text).then(() => {
    btn.textContent = 'Copied All!';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'Copy All'; btn.classList.remove('copied'); }, 2000);
  });
}

// ===== 3. SESSION FEED =====
async function loadSessions(append) {
  if (!append) {
    sessionOffset = 0;
    allSessionsLoaded = false;
    document.getElementById('session-feed').innerHTML = '';
  }

  const project = document.getElementById('filter-project').value;
  const search = document.getElementById('filter-search').value;
  const sort = document.getElementById('filter-sort').value;

  const params = new URLSearchParams({ limit: PAGE_SIZE, offset: sessionOffset, sort });
  if (project) params.set('project', project);
  if (search) params.set('search', search);

  const data = await api('/api/sessions?' + params);
  const feed = document.getElementById('session-feed');

  data.sessions.forEach(s => {
    const card = document.createElement('div');
    card.className = 's-card';
    card.id = 'scard-' + s.session_id;
    card.onclick = () => toggleSession(s.session_id, card);

    const dotColor = outcomeColor(s.judgment_outcome);
    const prod = s.productivity_ratio;

    let html = `
      <div class="s-outcome" style="background:${dotColor}"></div>
      <div style="min-width:0;flex:1">
        <div class="s-row1">
          <div class="s-prompt">${truncate(s.first_prompt, 80)}</div>
        </div>
        <div class="s-row2">
          <span>${shortProject(s.project_name)}</span>
          <span class="sep">&middot;</span>
          <span>${fmtDuration(s.duration_seconds)}</span>
          <span class="sep">&middot;</span>
          <span>${s.turn_count} msgs</span>
          ${s.misalignment_count > 0 ? `<span class="sep">&middot;</span><span style="color:var(--red)">${s.misalignment_count} issue${s.misalignment_count > 1 ? 's' : ''}</span>` : ''}
        </div>
      </div>
      ${prod != null ? `<div class="s-prod" style="background:${prodColor(prod)};color:white">${fmtPct(prod)}</div>` : ''}`;

    card.innerHTML = html;
    feed.appendChild(card);
  });

  sessionOffset += data.sessions.length;

  const loadMoreEl = document.getElementById('load-more');
  if (sessionOffset >= data.total) {
    allSessionsLoaded = true;
    loadMoreEl.style.display = 'none';
  } else {
    loadMoreEl.style.display = 'block';
  }
}

function loadMoreSessions() {
  if (!allSessionsLoaded) loadSessions(true);
}

// ===== SESSION DETAIL (in-place expand) =====
async function toggleSession(sessionId, cardEl) {
  // If already expanded, collapse
  if (expandedSessionId === sessionId) {
    const detail = cardEl.querySelector('.s-detail');
    if (detail) detail.remove();
    cardEl.classList.remove('expanded');
    expandedSessionId = null;
    return;
  }

  // Collapse previous
  if (expandedSessionId) {
    const prev = document.getElementById('scard-' + expandedSessionId);
    if (prev) {
      const d = prev.querySelector('.s-detail');
      if (d) d.remove();
      prev.classList.remove('expanded');
    }
  }

  expandedSessionId = sessionId;
  cardEl.classList.add('expanded');

  // Add loading placeholder
  const loadingDiv = document.createElement('div');
  loadingDiv.className = 's-detail';
  loadingDiv.innerHTML = '<div class="loading"><span class="spinner"></span></div>';
  cardEl.appendChild(loadingDiv);

  // Fetch detail + rich timeline + skills
  const fetchStart = performance.now();
  const [detail, timeline, skillsData] = await Promise.all([
    api(`/api/sessions/${sessionId}`),
    api(`/api/sessions/${sessionId}/rich-timeline`),
    api(`/api/skills/session/${sessionId}`),
  ]);
  console.log(`API fetch took ${(performance.now() - fetchStart).toFixed(0)}ms`);

  const s = detail.session;
  const j = detail.judgment;
  const tools = detail.tools;
  const f = detail.features;

  let html = '';

  // Badges row
  html += '<div class="detail-badges">';
  if (j) html += outcomeBadge(j.outcome) + ' ';
  html += intentBadge(s.intent) + ' ' + trajectoryBadge(s.trajectory);
  html += ` <span style="font-size:12px;color:var(--text-dim);margin-left:8px">${shortProject(s.project_name)}</span>`;
  html += '</div>';

  // Skill badges
  if (skillsData.skills) {
    html += renderSkillBadges(skillsData.skills);
  }

  // Narrative block (from enriched judgment)
  const narr = detail.narrative;
  if (narr && narr.narrative) {
    html += `<div class="narrative-block">
      <div class="ai-label">Story</div>
      <div class="narrative-text">${narr.narrative}</div>
    </div>`;

    // What worked / what failed side by side
    if (narr.what_worked || narr.what_failed) {
      html += '<div class="worked-failed">';
      if (narr.what_worked) html += `<div class="wf-card wf-good"><strong style="color:var(--green)">Worked:</strong> ${narr.what_worked}</div>`;
      if (narr.what_failed) html += `<div class="wf-card wf-bad"><strong style="color:var(--red)">Failed:</strong> ${narr.what_failed}</div>`;
      html += '</div>';
    }

    // User quote
    if (narr.user_quote) {
      html += `<div class="user-quote">"${narr.user_quote}"</div>`;
    }

    // CLAUDE.md suggestion
    if (narr.claude_md_suggestion) {
      html += `<div class="cmd-suggestion">
        <div class="cmd-rule">${narr.claude_md_suggestion}</div>
        <div class="cmd-rationale">${narr.claude_md_rationale || ''}</div>
      </div>`;
    }
  }

  if (j) {
    // Outcome reasoning
    if (j.outcome_reasoning) {
      html += `<div class="ai-section">
        <div class="ai-label">AI Analysis</div>
        <div class="ai-body">${j.outcome_reasoning}</div>
      </div>`;
    }

    // Prompt quality bars
    html += `<div class="quality-bars">
      <div class="quality-bar">
        <div class="bar-label">Clarity</div>
        <div class="bar-track"><div class="bar-fill" style="width:${(j.prompt_clarity||0)*100}%;background:${(j.prompt_clarity||0)>0.6?'var(--green)':'var(--yellow)'}"></div></div>
        <div class="bar-value">${fmtPct(j.prompt_clarity)}</div>
      </div>
      <div class="quality-bar">
        <div class="bar-label">Completeness</div>
        <div class="bar-track"><div class="bar-fill" style="width:${(j.prompt_completeness||0)*100}%;background:${(j.prompt_completeness||0)>0.6?'var(--green)':'var(--yellow)'}"></div></div>
        <div class="bar-value">${fmtPct(j.prompt_completeness)}</div>
      </div>
    </div>`;

    // Missing from prompt
    const missing = j.prompt_missing || [];
    if (missing.length > 0) {
      html += `<div class="ai-section">
        <div class="ai-label">Missing from prompt</div>
        <div class="tag-list">${missing.map(m => `<span class="tag">${m}</span>`).join('')}</div>
      </div>`;
    }

    // Trajectory narrative
    if (j.trajectory_summary) {
      html += `<div class="ai-section">
        <div class="ai-label">Trajectory</div>
        <div class="ai-body">${j.trajectory_summary}</div>
      </div>`;
    }

    // Misalignments + corrections — interleave by turn number with conversation context
    const misalignments = j.misalignments || [];
    const corrections = j.corrections || [];
    if (misalignments.length > 0 || corrections.length > 0) {
      // Build turn map from timeline: turn N -> {type, preview}
      const turnMap = {};
      let turnNum = 0;
      for (const e of timeline.timeline) {
        if (e.type === 'user' && !e.is_tool_result && e.text) {
          turnNum++;
          turnMap[turnNum] = { type: 'user', preview: truncate(e.text, 150) };
        } else if (e.type === 'assistant' && e.tools && e.tools.length) {
          turnNum++;
          turnMap[turnNum] = { type: 'assistant', preview: 'Tools: ' + e.tools.map(t => t.name).join(', ') };
        }
      }

      // Build combined list sorted by turn
      let issues = [];
      misalignments.forEach(m => issues.push({
        turn: m.turn || 0, type: 'misalignment',
        label: 'Claude went wrong',
        desc: m.description || m
      }));
      corrections.forEach(c => issues.push({
        turn: c.turn || 0, type: 'correction',
        label: 'You corrected',
        desc: c.description || c
      }));
      issues.sort((a, b) => a.turn - b.turn);

      html += `<div class="ai-section">
        <div class="ai-label">Misalignments & Corrections (${misalignments.length} + ${corrections.length})</div>
        <div class="issue-list">${issues.map(i => {
          const ctx = turnMap[i.turn];
          const ctxHtml = ctx
            ? `<div class="issue-context ctx-${ctx.type}">${ctx.type === 'user' ? 'You' : 'Claude'}: ${ctx.preview}</div>`
            : '';
          return `<div class="issue-item ${i.type}">
            <span class="turn-num">Turn ${i.turn || '?'}</span>
            <div>
              <span style="font-size:11px;opacity:0.7">${i.label}:</span>
              <span class="issue-desc">${i.desc}</span>
              ${ctxHtml}
            </div>
          </div>`;
        }).join('')}</div>
      </div>`;
    }

    // Productivity bar
    const prodTurns = j.productive_turns || 0;
    const wasteTurns = j.waste_turns || 0;
    const totalProdTurns = prodTurns + wasteTurns;
    if (totalProdTurns > 0) {
      const pp = (prodTurns / totalProdTurns * 100).toFixed(0);
      const wp = (wasteTurns / totalProdTurns * 100).toFixed(0);
      html += `<div class="ai-section">
        <div class="ai-label">Productivity</div>
        <div class="prod-bar-wrap">
          <div class="prod-bar-track">
            <div class="productive" style="width:${pp}%"></div>
            <div class="waste" style="width:${wp}%"></div>
          </div>
          <div class="prod-bar-labels">
            <span>${prodTurns} productive (${pp}%)</span>
            <span>${wasteTurns} waste (${wp}%)</span>
          </div>
        </div>
      </div>`;
    }
  } else {
    // No judgment — show basic stats
    html += `<div class="ai-section">
      <div class="ai-body" style="color:var(--text-dim)">No AI analysis available. Run the LLM Judge to get detailed insights.</div>
    </div>`;
    html += `<div style="display:flex;gap:16px;flex-wrap:wrap;font-size:12px;color:var(--text-dim);margin-bottom:12px">
      <span>Duration: ${fmtDuration(s.duration_seconds)}</span>
      <span>Turns: ${s.turn_count}</span>
      <span>Tool uses: ${s.tool_use_count}</span>
      <span>Tool errors: ${s.tool_error_count}</span>
    </div>`;
  }

  // Tool usage (horizontal bar chart, CSS-based)
  if (tools.length > 0) {
    const maxUse = Math.max(...tools.map(t => t.use_count));
    html += `<div class="ai-section">
      <div class="ai-label">Tools</div>
      <div class="tool-chart-wrap">
        ${tools.slice(0, 10).map(t => `
          <div class="tool-bar-row">
            <div class="tool-bar-name">${t.tool_name}</div>
            <div class="tool-bar-track"><div class="tool-bar-fill" style="width:${(t.use_count/maxUse*100).toFixed(0)}%"></div></div>
            <div class="tool-bar-count">${t.use_count}</div>
          </div>
        `).join('')}
      </div>
    </div>`;
  }

  // Collapsible timeline — message-entry style
  const timelineId = 'tl-' + sessionId;
  // Build result map: tool_id → {result_preview, is_error} for pairing tool calls with outputs
  const resultMap = {};
  for (const e of timeline.timeline) {
    if (e.is_tool_result && e.tool_id) {
      resultMap[e.tool_id] = { preview: e.result_preview, is_error: e.is_error };
    }
  }

  // Render timeline entries — skip empty assistant entries and consumed tool_results
  function renderRichTool(t) {
    const shortName = t.name.replace(/^mcp__[^_]+__/, '').replace(/__/g, '_');
    // Format input nicely: try to show key=val for simple objects, else truncate JSON
    let inputHtml = '';
    try {
      const inp = JSON.parse(t.input_preview);
      const keys = Object.keys(inp);
      if (keys.length <= 4 && keys.every(k => typeof inp[k] !== 'object')) {
        inputHtml = keys.map(k => `<span style="color:var(--text-sec)">${esc(k)}</span>=<span style="color:var(--text)">${esc(String(inp[k]).slice(0, 60))}</span>`).join(' ');
      } else {
        inputHtml = `<span style="color:var(--text-dim)">${esc(truncate(t.input_preview, 120))}</span>`;
      }
    } catch { inputHtml = `<span style="color:var(--text-dim)">${esc(truncate(t.input_preview, 120))}</span>`; }

    const res = resultMap[t.id];
    let resultHtml = '';
    if (res) {
      const resCls = res.is_error ? 'tl-tool-result tl-result-err' : 'tl-tool-result';
      const resText = res.preview ? esc(truncate(res.preview, 200)) : (res.is_error ? 'error' : 'ok');
      resultHtml = `<div class="${resCls}">${resText}</div>`;
    }

    return `<div class="tl-tool-call">
      <span class="tl-tool-name">${esc(shortName)}</span> <span style="font-size:10px;font-family:var(--font-mono)">${inputHtml}</span>
      ${resultHtml}
    </div>`;
  }

  const tlEntries = timeline.timeline.filter(e => {
    if (e.is_tool_result) return false; // consumed by resultMap
    if (e.type === 'assistant' && !e.text && (!e.tools || !e.tools.length)) return false; // empty
    return true;
  });

  const tlLabel = `${tlEntries.length} turns`;
  html += `<div class="ai-section">
    <div class="timeline-toggle" onclick="event.stopPropagation(); document.getElementById('${timelineId}').classList.toggle('open'); this.textContent = document.getElementById('${timelineId}').classList.contains('open') ? '\u25BE Hide timeline (${tlLabel})' : '\u25B8 Show timeline (${tlLabel})'">
      \u25B8 Show timeline (${tlLabel})
    </div>
    <div class="timeline-content" id="${timelineId}">
      ${tlEntries.map(e => {
        const roleCls = { user: 'tl-user', assistant: 'tl-assistant', system: 'tl-system' }[e.type] || 'tl-system';
        const roleLabel = e.type;
        const roleLabelCls = { user: 'r-user', assistant: 'r-assistant' }[e.type] || 'r-system';

        let content = '';
        if (e.type === 'user') {
          content = `<div class="tl-preview">${esc(truncate(e.text || '', 200))}</div>`;
        } else if (e.type === 'assistant') {
          if (e.text) content += `<div class="tl-preview">${esc(truncate(e.text, 200))}</div>`;
          if (e.tools && e.tools.length) {
            content += `<div class="tl-tools">${e.tools.map(renderRichTool).join('')}</div>`;
          }
        } else if (e.type === 'system') {
          content = `<div class="tl-preview">${esc(e.system_subtype || '')}${e.duration_ms ? ' (' + (e.duration_ms/1000).toFixed(1) + 's)' : ''}</div>`;
        }

        return `<div class="tl-msg ${roleCls}">
          <div class="tl-header">
            <span class="tl-role ${roleLabelCls}">${roleLabel}</span>
            <span class="tl-time">${fmtDate(e.timestamp)}</span>
          </div>
          ${content}
        </div>`;
      }).join('')}
    </div>
  </div>`;

  const renderStart = performance.now();
  loadingDiv.innerHTML = html;
  console.log(`HTML render took ${(performance.now() - renderStart).toFixed(0)}ms`);
  console.log(`Total session expand took ${(performance.now() - fetchStart).toFixed(0)}ms`);
}

// ===== FILTERS =====
['filter-project', 'filter-sort'].forEach(id => {
  document.getElementById(id).addEventListener('change', () => {
    expandedSessionId = null;
    loadSessions(false);
  });
});
let searchTimeout;
const searchInput = document.getElementById('filter-search');
const searchPanel = document.getElementById('search-panel');

searchInput.addEventListener('input', () => {
  clearTimeout(searchTimeout);
  const q = searchInput.value.trim();
  if (q.length < 2) {
    searchPanel.classList.remove('open');
    if (q.length === 0) {
      // Back to tree view
      showTreeView();
    } else {
      // Short query: show flat with basic filter
      document.getElementById('session-tree').style.display = 'none';
      document.getElementById('session-feed-wrap').style.display = 'block';
      searchTimeout = setTimeout(() => { expandedSessionId = null; loadSessions(false); }, 300);
    }
    return;
  }
  // Longer query: switch to flat list + FTS dropdown
  document.getElementById('session-tree').style.display = 'none';
  document.getElementById('session-feed-wrap').style.display = 'block';
  searchTimeout = setTimeout(() => { expandedSessionId = null; loadSessions(false); doFullTextSearch(q); }, 300);
});

searchInput.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    searchPanel.classList.remove('open');
    searchInput.blur();
  }
});

// Close search panel when clicking outside
document.addEventListener('click', (e) => {
  if (!e.target.closest('.filter-bar')) {
    searchPanel.classList.remove('open');
  }
});

async function doFullTextSearch(q) {
  const project = document.getElementById('filter-project').value;
  const params = new URLSearchParams({ q, limit: 20 });
  if (project) params.set('project', project);

  // Show loading state
  searchPanel.innerHTML = '<div class="search-empty" style="display:flex;align-items:center;gap:8px"><span class="spinner" style="width:14px;height:14px;border-width:2px"></span> Searching…</div>';
  searchPanel.classList.add('open');

  try {
    const data = await api('/api/search?' + params);
    if (data.results.length === 0) {
      searchPanel.innerHTML = '<div class="search-empty">No results found</div>';
      searchPanel.classList.add('open');
      return;
    }

    searchPanel.innerHTML = data.results.map(r => {
      const roleColor = r.entry_type === 'user' ? 'var(--accent)' : 'var(--accent2)';
      const roleChar = r.entry_type === 'user' ? 'U' : 'A';
      const short = shortProject(r.project || '');
      // Sanitize snippet — only allow <mark> tags
      const snippet = sanitizeSnippet(r.snippet || '');
      return `<div class="search-result" onclick="jumpToSession('${r.session_id}')">
        <div class="sr-role" style="background:${roleColor}">${roleChar}</div>
        <div class="sr-body">
          <div class="sr-snippet">${snippet}</div>
          <div class="sr-meta">${short} &middot; ${fmtDate(r.started_at)} &middot; ${r.first_prompt ? truncate(r.first_prompt, 50) : ''}</div>
        </div>
      </div>`;
    }).join('');
    searchPanel.classList.add('open');
  } catch (e) {
    console.error('Search failed:', e);
  }
}

function sanitizeSnippet(html) {
  // Only allow <mark> tags for search highlights — strip everything else
  return html
    .replace(/<mark>/gi, '\x00OPEN\x00')
    .replace(/<\/mark>/gi, '\x00CLOSE\x00')
    .replace(/</g, '&lt;').replace(/>/g, '&gt;')
    .replaceAll('\x00OPEN\x00', '<mark>')
    .replaceAll('\x00CLOSE\x00', '</mark>');
}

function jumpToSession(sessionId) {
  searchPanel.classList.remove('open');
  searchInput.value = '';
  switchTab('sessions');
  // Find the session card in the current loaded list
  const card = document.getElementById('scard-' + sessionId);
  if (card) {
    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
    setTimeout(() => toggleSession(sessionId, card), 300);
  } else {
    // Session not in current page — reset filters and search by ID
    document.getElementById('filter-project').value = '';
    document.getElementById('filter-sort').value = 'started_at DESC';
    expandedSessionId = null;
    // Use the API search parameter which searches session_id
    const origSearch = searchInput.value;
    searchInput.value = '';
    // Load all sessions and try to find it
    loadSessions(false).then(() => {
      // Try expanding — the session might be in the first page now
      setTimeout(() => {
        const c = document.getElementById('scard-' + sessionId);
        if (c) {
          c.scrollIntoView({ behavior: 'smooth', block: 'center' });
          setTimeout(() => toggleSession(sessionId, c), 300);
        }
      }, 500);
    });
  }
}

function populateFilters(projects) {
  const projSelect = document.getElementById('filter-project');
  projSelect.innerHTML = '<option value="">All Projects</option>';
  (projects || []).forEach(p => {
    projSelect.innerHTML += `<option value="${p.project_name}">${shortProject(p.project_name)} (${p.session_count})</option>`;
  });
}

function filterByProject(projectName) {
  switchTab('sessions');
  openProjectInTree(projectName);
}

function openProjectInTree(projectName) {
  // Clear any search/filter state
  document.getElementById('filter-project').value = '';
  document.getElementById('filter-search').value = '';
  document.getElementById('session-tree').style.display = 'block';
  document.getElementById('session-feed-wrap').style.display = 'none';

  const projEl = document.getElementById('st-proj-' + CSS.escape(projectName));
  if (projEl) {
    if (!projEl.classList.contains('open')) toggleProjectTree(projectName);
    setTimeout(() => projEl.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
  }
}

// ===== SESSION TREE =====
let _treeSortKey = 'sessions';

function renderSessionTree() {
  const projList = window._projList || [];
  const treeEl = document.getElementById('session-tree');
  if (!treeEl) return;

  const sortFns = {
    sessions: (a, b) => b.session_count - a.session_count,
    productivity: (a, b) => (b.avg_productivity || 0) - (a.avg_productivity || 0),
    completion: (a, b) => (b.completion_rate || 0) - (a.completion_rate || 0),
    name: (a, b) => a.project_name.localeCompare(b.project_name),
  };
  const sorted = [...projList].sort(sortFns[_treeSortKey] || sortFns.sessions);

  // Preserve open state
  const openProjects = new Set(
    [...document.querySelectorAll('.st-project.open')].map(el => el.dataset.project)
  );

  treeEl.innerHTML = sorted.map(p => {
    const prod = p.avg_productivity;
    const comp = p.completion_rate;
    const isOpen = openProjects.has(p.project_name);
    const pc = v => v != null ? (v >= 0.7 ? 'var(--green)' : v >= 0.4 ? 'var(--yellow)' : 'var(--red)') : 'var(--text-dim)';
    const totalTok = (p.total_input_tokens || 0) + (p.total_output_tokens || 0);
    return `<div class="st-project${isOpen ? ' open' : ''}" id="st-proj-${CSS.escape(p.project_name)}" data-project="${esc(p.project_name)}" data-loaded="">
      <div class="st-proj-header" onclick="toggleProjectTree('${esc(p.project_name).replace(/'/g,"\\'")}')">
        <span class="st-caret">&#9654;</span>
        <span class="st-proj-name">${shortProject(p.project_name)}</span>
        <span class="st-proj-meta">${p.session_count} session${p.session_count !== 1 ? 's' : ''}</span>
        <div class="st-proj-stats">
          ${prod != null ? `<span class="st-stat" style="color:${pc(prod)}">${fmtPct(prod)} prod</span>` : ''}
          ${comp != null ? `<span class="st-stat" style="color:${pc(comp)}">${fmtPct(comp)} done</span>` : ''}
          ${p.total_errors ? `<span class="st-stat" style="color:var(--red)">${p.total_errors} err</span>` : ''}
          <span class="st-stat">${fmtTokens(totalTok)}</span>
        </div>
      </div>
      <div class="st-sessions" style="display:${isOpen ? 'block' : 'none'}">
        <div class="loading" style="padding:20px"><span class="spinner"></span></div>
      </div>
    </div>`;
  }).join('');

  // Re-load sessions for projects that were open
  for (const proj of openProjects) loadProjectSessions(proj);
}

async function toggleProjectTree(projectName) {
  const projEl = document.getElementById('st-proj-' + CSS.escape(projectName));
  if (!projEl) return;
  const isOpen = projEl.classList.toggle('open');
  const sessionsEl = projEl.querySelector('.st-sessions');
  sessionsEl.style.display = isOpen ? 'block' : 'none';
  if (isOpen && !projEl.dataset.loaded) loadProjectSessions(projectName);
}

async function loadProjectSessions(projectName) {
  const projEl = document.getElementById('st-proj-' + CSS.escape(projectName));
  if (!projEl) return;
  projEl.dataset.loaded = '1';
  const sessionsEl = projEl.querySelector('.st-sessions');
  const data = await api(`/api/sessions?limit=30&sort=started_at+DESC&project=${encodeURIComponent(projectName)}`);
  sessionsEl.innerHTML = '';
  data.sessions.forEach(s => {
    const card = document.createElement('div');
    card.className = 's-card';
    card.id = 'scard-' + s.session_id;
    card.onclick = () => toggleSession(s.session_id, card);
    const dotColor = outcomeColor(s.judgment_outcome);
    const prod = s.productivity_ratio;
    card.innerHTML = `
      <div class="s-outcome" style="background:${dotColor}"></div>
      <div style="min-width:0;flex:1">
        <div class="s-row1"><div class="s-prompt">${truncate(s.first_prompt, 80)}</div></div>
        <div class="s-row2">
          <span>${fmtDuration(s.duration_seconds)}</span>
          <span class="sep">&middot;</span>
          <span>${s.turn_count} msgs</span>
          ${s.misalignment_count > 0 ? `<span class="sep">&middot;</span><span style="color:var(--red)">${s.misalignment_count} issue${s.misalignment_count > 1 ? 's' : ''}</span>` : ''}
        </div>
      </div>
      ${prod != null ? `<div class="s-prod" style="background:${prodColor(prod)};color:white">${fmtPct(prod)}</div>` : ''}`;
    sessionsEl.appendChild(card);
  });
  if (data.total > data.sessions.length) {
    const more = document.createElement('div');
    more.className = 'st-more';
    more.textContent = `Show all ${data.total} sessions →`;
    more.onclick = e => { e.stopPropagation(); showFlatByProject(projectName); };
    sessionsEl.appendChild(more);
  }
}

function showFlatByProject(projectName) {
  document.getElementById('filter-project').value = projectName;
  document.getElementById('session-tree').style.display = 'none';
  document.getElementById('session-feed-wrap').style.display = 'block';
  expandedSessionId = null;
  loadSessions(false);
}

function showTreeView() {
  document.getElementById('filter-project').value = '';
  document.getElementById('session-tree').style.display = 'block';
  document.getElementById('session-feed-wrap').style.display = 'none';
}

document.getElementById('tree-sort').addEventListener('change', e => {
  _treeSortKey = e.target.value;
  renderSessionTree();
});

// ===== TABS =====
function switchTab(tabName) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelector(`.tab-btn[data-tab="${tabName}"]`).classList.add('active');
  document.getElementById('tab-' + tabName).classList.add('active');
}

// ===== SKILLS (radar + legend in verdict) =====
function renderSkillRadar(dims, profile) {
  const n = dims.length;
  const sz = 200, cx = sz / 2, cy = sz / 2, r = 72;
  const pt = (i, f) => {
    const a = (2 * Math.PI * i / n) - Math.PI / 2;
    return [cx + f * r * Math.cos(a), cy + f * r * Math.sin(a)];
  };
  let svg = `<svg width="${sz}" height="${sz}" viewBox="0 0 ${sz} ${sz}" style="display:block">`;
  // Level labels on vertical axis (L1–L4)
  for (let lv = 1; lv <= 4; lv++) {
    const [lx, ly] = pt(0, lv / 5);
    svg += `<text x="${(lx + 2).toFixed(1)}" y="${(ly - 1).toFixed(1)}" font-size="8" fill="var(--text-dim)" opacity="0.6">L${lv}</text>`;
  }
  // Grid rings
  for (let lv = 1; lv <= 5; lv++) {
    const pts = dims.map((_, i) => { const [x, y] = pt(i, lv / 5); return `${x.toFixed(1)},${y.toFixed(1)}`; }).join(' ');
    svg += `<polygon points="${pts}" fill="none" stroke="var(--border-muted)" stroke-width="${lv === 5 ? 0.8 : 0.4}"/>`;
  }
  // Axes
  dims.forEach((d, i) => {
    const [x, y] = pt(i, 1);
    svg += `<line x1="${cx}" y1="${cy}" x2="${x.toFixed(1)}" y2="${y.toFixed(1)}" stroke="${d.color}" stroke-width="0.6" opacity="0.35"/>`;
  });
  // Score polygon
  const scores = dims.map(d => Math.min((profile['d' + parseInt(d.id.slice(1)) + '_score'] || 0) / 5, 1));
  const polyPts = dims.map((_, i) => { const [x, y] = pt(i, scores[i]); return `${x.toFixed(1)},${y.toFixed(1)}`; }).join(' ');
  svg += `<polygon points="${polyPts}" fill="var(--purple)" fill-opacity="0.2" stroke="var(--purple)" stroke-width="1.5" stroke-linejoin="round"/>`;
  // Colored vertex dots + axis-end dots
  dims.forEach((d, i) => {
    const score = profile['d' + parseInt(d.id.slice(1)) + '_score'] || 0;
    const [vx, vy] = pt(i, scores[i]);
    const [ax, ay] = pt(i, 1.0);
    // Axis endpoint dot
    svg += `<circle cx="${ax.toFixed(1)}" cy="${ay.toFixed(1)}" r="2.5" fill="${d.color}" opacity="0.4"/>`;
    // Score dot
    if (scores[i] > 0.05) {
      svg += `<circle cx="${vx.toFixed(1)}" cy="${vy.toFixed(1)}" r="3.5" fill="${d.color}" stroke="var(--bg)" stroke-width="1"><title>${d.short}: L${Math.floor(score)} (${score.toFixed(1)})</title></circle>`;
    }
  });
  svg += '</svg>';
  return svg;
}

async function loadSkills() {
  const [dims, profile, nudges, detail] = await Promise.all([
    api('/api/skills/dimensions'),
    api('/api/skills/profile'),
    api('/api/skills/nudges'),
    api('/api/skills/dimensions/detail'),
  ]);

  const p = profile.profile;
  const dimList = dims.dimensions;

  const radarWrap = document.getElementById('skill-radar-wrap');
  const legendWrap = document.getElementById('skill-legend-wrap');

  if (!p) {
    if (radarWrap) radarWrap.innerHTML = '<div style="font-size:11px;color:var(--text-dim);padding:8px">No skill data yet.</div>';
    return;
  }

  const scores = dimList.map(d => p['d' + parseInt(d.id.slice(1)) + '_score'] || 0);
  const avg = scores.reduce((a, b) => a + b, 0) / scores.length;
  const gaps = [p.gap_1, p.gap_2, p.gap_3].filter(Boolean);
  const detailMap = {};
  (detail.dimensions || []).forEach(dd => { detailMap[dd.id] = dd; });

  // Radar
  if (radarWrap) {
    radarWrap.innerHTML = renderSkillRadar(dimList, p)
      + `<div style="font-size:10px;color:var(--text-dim);text-align:center;margin-top:2px">Avg L${Math.floor(avg)} (${avg.toFixed(1)})${gaps.length ? ` · <span style="color:var(--yellow)">${gaps.length} gap${gaps.length > 1 ? 's' : ''}</span>` : ''}</div>`;
  }

  // Legend: dimension name + mini bar + level + level-up nudge on click
  if (legendWrap) {
    legendWrap.innerHTML = dimList.map((d, i) => {
      const score = scores[i];
      const level = Math.floor(score);
      const pct = (score / 5 * 100).toFixed(0);
      const isGap = gaps.includes(d.id);
      const dd = detailMap[d.id] || {};
      const nudgeText = dd.nudge ? `To reach L${level + 1}: ${dd.nudge}` : '';
      return `<div class="skill-legend-row" onclick="this.classList.toggle('open')" style="cursor:pointer;background:var(--surface2);border-radius:5px;padding:8px 12px;border-left:3px solid ${d.color};display:flex;flex-direction:column;justify-content:center" data-nudge="${esc(nudgeText)}">
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-size:13px;color:var(--text-sec);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${d.short}</span>
          <span style="font-size:12px;font-weight:700;color:${d.color};background:${d.color}22;padding:2px 7px;border-radius:4px;flex-shrink:0">${isGap ? '▲' : ''}L${level}</span>
        </div>
        ${nudgeText ? `<div class="skill-legend-nudge">${nudgeText}</div>` : ''}
      </div>`;
    }).join('');
  }

  // Nudges — show inline below verdict if any active
  const nudgeSection = document.getElementById('skill-nudges-section');
  if (nudgeSection) {
    const active = (nudges.nudges || []).filter(n => !n.dismissed);
    nudgeSection.style.display = active.length ? 'block' : 'none';
    nudgeSection.innerHTML = active.length ? `
      <div class="section-label" style="color:var(--purple)">Skill Nudges</div>
      <div class="nudge-cards">${active.slice(0, 3).map(n => `
        <div class="nudge-card" id="nudge-${n.id}" style="border-left-color:${n.dimension_color}">
          <div class="nudge-header">
            <span class="nudge-dim" style="color:${n.dimension_color}">${n.dimension_name}</span>
            <span class="nudge-level">L${n.current_level} &#8594; L${n.target_level}</span>
          </div>
          <div class="nudge-text">${n.nudge_text}</div>
          <span class="nudge-dismiss" onclick="event.stopPropagation();dismissNudge(${n.id})">dismiss</span>
        </div>`).join('')}
      </div>` : '';
  }
}

async function dismissNudge(id) {
  await fetch('/api/skills/nudges/' + id + '/dismiss', { method: 'POST' });
  const el = document.getElementById('nudge-' + id);
  if (el) el.remove();
}

async function showSession(sessionId) {
  const modal = document.getElementById('session-modal');
  const content = document.getElementById('session-modal-content');
  modal.classList.add('active');
  content.innerHTML = '<div class="loading"><span class="spinner"></span></div>';

  try {
    const [detail, timeline] = await Promise.all([
      api('/api/sessions/' + sessionId),
      api('/api/sessions/' + sessionId + '/timeline?full=1'),
    ]);
    const s = detail.session;
    const entries = timeline.timeline || [];

    let html = `<div class="modal-header">`;
    html += `<h3>${s.first_prompt ? s.first_prompt.slice(0, 120) : sessionId}</h3>`;
    html += `<div class="modal-meta">`;
    html += `<span>${s.started_at ? new Date(s.started_at).toLocaleString() : ''}</span>`;
    html += `<span class="sep">&middot;</span>`;
    html += `<span>${s.turn_count || 0} turns</span>`;
    html += `<span class="sep">&middot;</span>`;
    html += `<span>${Math.round((s.duration_seconds || 0) / 60)}m</span>`;
    if (s.project_name) {
      html += `<span class="sep">&middot;</span>`;
      html += `<span>${shortProject(s.project_name)}</span>`;
    }
    html += `</div></div>`;

    if (detail.judgment) {
      const j = detail.judgment;
      html += `<div class="modal-judgment">`;
      html += `<strong>${j.outcome}</strong> &middot; ${(j.productivity_ratio * 100).toFixed(0)}% productive`;
      if (j.trajectory_summary) html += `<div class="judge-summary">${j.trajectory_summary}</div>`;
      html += `</div>`;
    }

    // Build message-style timeline with markdown rendering
    html += '<div class="modal-body">';
    html += '<div class="modal-section-label">Conversation</div>';
    let turnNum = 0;
    let i = 0;
    while (i < entries.length) {
      const e = entries[i];
      if (e.entry_type === 'user' && !e.is_tool_result && (e.user_text || e.preview)) {
        turnNum++;
        const text = e.user_text || e.preview || '';
        html += `<div class="msg-entry msg-user">`;
        html += `<div class="msg-header"><span class="msg-role-icon" style="background:var(--accent)">U</span><span class="msg-role role-user">User</span><span class="msg-turn">Turn ${turnNum}</span></div>`;
        html += renderMessage(text);
        html += `</div>`;
        i++;
      } else if (e.entry_type === 'assistant') {
        const tools = [];
        let hasError = false;
        let assistantText = '';
        while (i < entries.length && (entries[i].entry_type === 'assistant' || (entries[i].entry_type === 'user' && entries[i].is_tool_result))) {
          const ae = entries[i];
          if (ae.tool_names) {
            const t = typeof ae.tool_names === 'string' ? ae.tool_names.split(',') : ae.tool_names;
            t.forEach(x => { const n = x.trim(); if (n && !tools.includes(n)) tools.push(n); });
          }
          if (ae.tool_result_error) hasError = true;
          // Capture assistant text (reasoning before tool calls)
          if (ae.entry_type === 'assistant' && ae.preview && !ae.tool_names) {
            assistantText = ae.preview;
          }
          i++;
        }
        turnNum++;
        html += `<div class="msg-entry msg-assistant">`;
        html += `<div class="msg-header"><span class="msg-role-icon" style="background:var(--accent2)">A</span><span class="msg-role role-assistant">Assistant</span><span class="msg-turn">Turn ${turnNum}</span></div>`;
        if (assistantText) html += `<div class="msg-text" style="color:var(--text-dim);font-size:13px;margin-bottom:6px">${renderMd(assistantText)}</div>`;
        if (tools.length) html += `<div class="msg-tools">${tools.map(t => `<span>${t}</span>`).join('')}</div>`;
        if (hasError) html += `<div class="msg-error">Error during execution</div>`;
        html += `</div>`;
      } else {
        i++;
      }
    }
    html += '</div>';

    content.innerHTML = html;
  } catch (err) {
    content.innerHTML = `<div style="color:var(--red)">Failed to load session: ${err.message}</div>`;
  }
}

function closeSessionModal() {
  document.getElementById('session-modal').classList.remove('active');
}

function renderSkillBadges(skills) {
  if (!skills || !window._skillDims) return '';
  const dims = window._skillDims;
  let html = '<div class="skill-badges">';
  for (const d of dims) {
    const num = parseInt(d.id.slice(1));
    const level = skills['d' + num + '_level'] || 0;
    const opp = skills['d' + num + '_opportunity'] || 0;
    if (level > 0 || opp > 0) {
      const hasGap = opp > level;
      html += `<span class="skill-badge${hasGap ? ' has-gap' : ''}" style="${!hasGap ? 'border-left:2px solid ' + d.color : ''}">L${level} ${d.short}${hasGap ? ' &#9650;' : ''}</span>`;
    }
  }
  html += '</div>';
  return html;
}

async function loadCharts() {
  const [heatmap, calData, sessData] = await Promise.all([
    api('/api/heatmap'),
    api('/api/heatmap/calendar'),
    api('/api/sessions?limit=50&sort=started_at+ASC'),
  ]);

  const textDim = getCSSVar('--text-dim');
  const gridColor = getCSSVar('--border');
  const greenColor = getCSSVar('--green');

  // Productivity trend (judged sessions only)
  const sessArr = sessData.sessions.filter(s => s.productivity_ratio != null);
  destroyChart('trends');
  const trendsCanvas = document.getElementById('chart-trends');
  if (sessArr.length > 0) {
    charts.trends = new Chart(trendsCanvas, {
      type: 'line',
      data: {
        labels: sessArr.map((_, i) => i + 1),
        datasets: [
          { label: 'Productivity', data: sessArr.map(s => s.productivity_ratio), borderColor: greenColor, backgroundColor: greenColor + '1a', fill: true, tension: 0.3, pointRadius: 2 },
        ]
      },
      options: { responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, y: { min: 0, max: 1, ticks: { color: textDim, callback: v => (v*100)+'%' }, grid: { color: gridColor } } }, plugins: { legend: { labels: { color: textDim } } } }
    });
  } else {
    const ctx = trendsCanvas.getContext('2d');
    ctx.clearRect(0, 0, trendsCanvas.width, trendsCanvas.height);
    ctx.fillStyle = textDim;
    ctx.font = '13px -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('No productivity data yet', trendsCanvas.width / 2, trendsCanvas.height / 2 - 10);
    ctx.font = '11px -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif';
    ctx.fillText('Use "Run LLM Judge" to rate sessions', trendsCanvas.width / 2, trendsCanvas.height / 2 + 10);
  }

  // Calendar heatmap — defer one frame so container has its layout width
  requestAnimationFrame(() => renderCalendarHeatmap(calData.calendar));

  // Day x Hour heatmap
  renderHeatmap(heatmap.heatmap);
}

async function loadProjectHealth() {
  const projects = await api('/api/projects');
  window._projList = projects.projects;
  renderSessionTree();
}

// Project health table

function fmtCostConv(p, allProjects) {
  const totalTokens = (p.total_input_tokens || 0) + (p.total_output_tokens || 0);
  if (!totalTokens || !p.session_count) return '-';
  const tps = totalTokens / p.session_count;
  const label = fmtTokens(Math.round(tps));
  const allTps = allProjects.map(q => {
    const t = (q.total_input_tokens || 0) + (q.total_output_tokens || 0);
    return q.session_count ? t / q.session_count : 0;
  }).filter(v => v > 0).sort((a, b) => a - b);
  if (allTps.length < 2) return label;
  const median = allTps[Math.floor(allTps.length / 2)];
  if (tps < median * 0.7) return '<span style="color:var(--green)">' + label + '</span>';
  if (tps > median * 1.5) return '<span style="color:var(--red)">' + label + '</span>';
  return label;
}


function renderCalendarHeatmap(data) {
  const container = document.getElementById('calendar-container');
  const isLight = document.documentElement.hasAttribute('data-theme');

  // Build date -> count map
  const countMap = {};
  data.forEach(d => { countMap[d.date] = d.count; });
  const maxCount = Math.max(...data.map(d => d.count), 1);

  // Green scale (GitHub-style)
  const emptyColor = isLight ? '#ebedf0' : '#161b22';
  const greenScale = isLight
    ? ['#9be9a8', '#40c463', '#30a14e', '#216e39']
    : ['#0e4429', '#006d32', '#26a641', '#39d353'];

  function cellColor(count) {
    if (!count) return emptyColor;
    const ratio = count / maxCount;
    if (ratio <= 0.25) return greenScale[0];
    if (ratio <= 0.5) return greenScale[1];
    if (ratio <= 0.75) return greenScale[2];
    return greenScale[3];
  }

  // Build weeks: go back ~52 weeks from today
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const dayOfWeek = (today.getDay() + 6) % 7; // Mon=0
  const startDate = new Date(today);
  startDate.setDate(startDate.getDate() - (52 * 7 + dayOfWeek));

  const labelWidth = 28;
  const headerHeight = 16;
  const cellGap = 2;
  const dayLabels = ['Mon', '', 'Wed', '', 'Fri', '', ''];

  // Count weeks
  let weeks = [];
  let current = new Date(startDate);
  let weekCells = [];
  while (current <= today) {
    const dow = (current.getDay() + 6) % 7;
    const dateStr = current.toISOString().slice(0, 10);
    weekCells.push({ date: dateStr, dow, count: countMap[dateStr] || 0 });
    if (dow === 6 || current.getTime() === today.getTime()) {
      weeks.push(weekCells);
      weekCells = [];
    }
    current.setDate(current.getDate() + 1);
  }
  if (weekCells.length) weeks.push(weekCells);

  // Use 13px cells to match the day/hour heatmap cell size
  const cellSize = 13;
  const step = cellSize + cellGap;

  const svgWidth = labelWidth + weeks.length * step + 4;
  const svgHeight = headerHeight + 7 * step + 4;

  let svg = `<svg width="${svgWidth}" height="${svgHeight}" xmlns="http://www.w3.org/2000/svg">`;

  // Day labels (Mon, Wed, Fri)
  for (let d = 0; d < 7; d++) {
    if (dayLabels[d]) {
      svg += `<text class="cal-day-label" x="${labelWidth - 4}" y="${headerHeight + d * step + cellSize - 1}" text-anchor="end">${dayLabels[d]}</text>`;
    }
  }

  // Month labels
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  let lastMonth = -1;
  let lastLabelX = -100;
  weeks.forEach((week, wi) => {
    const firstDay = week[0];
    const d = new Date(firstDay.date);
    const m = d.getMonth();
    const x = labelWidth + wi * step;
    if (m !== lastMonth && (x - lastLabelX) > 28) {
      lastMonth = m;
      lastLabelX = x;
      svg += `<text class="cal-month" x="${x}" y="${10}">${months[m]}</text>`;
    }
  });

  // Cells
  weeks.forEach((week, wi) => {
    week.forEach(cell => {
      const x = labelWidth + wi * step;
      const y = headerHeight + cell.dow * step;
      const color = cellColor(cell.count);
      svg += `<rect class="cal-cell" x="${x}" y="${y}" width="${cellSize}" height="${cellSize}" fill="${color}" data-date="${cell.date}" data-count="${cell.count}"/>`;
    });
  });

  svg += '</svg>';

  // Legend
  svg += `<div class="cal-legend">
    <span>Less</span>
    <div class="cal-legend-cell" style="background:${emptyColor}"></div>
    ${greenScale.map(c => `<div class="cal-legend-cell" style="background:${c}"></div>`).join('')}
    <span>More</span>
  </div>`;

  container.innerHTML = svg;

  // Tooltip
  let tooltip = document.getElementById('cal-tooltip');
  if (!tooltip) {
    tooltip = document.createElement('div');
    tooltip.id = 'cal-tooltip';
    tooltip.className = 'cal-tooltip';
    tooltip.style.display = 'none';
    document.body.appendChild(tooltip);
  }

  container.addEventListener('mouseover', e => {
    const rect = e.target.closest('.cal-cell');
    if (!rect) { tooltip.style.display = 'none'; return; }
    const date = rect.getAttribute('data-date');
    const count = rect.getAttribute('data-count');
    const d = new Date(date + 'T00:00:00');
    const label = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
    tooltip.textContent = `${count} session${count !== '1' ? 's' : ''} on ${label}`;
    tooltip.style.display = 'block';
    const r = rect.getBoundingClientRect();
    let left = r.left + r.width / 2 - tooltip.offsetWidth / 2;
    let top = r.top - tooltip.offsetHeight - 6;
    // Clamp to viewport
    left = Math.max(8, Math.min(left, window.innerWidth - tooltip.offsetWidth - 8));
    if (top < 8) top = r.bottom + 6;
    tooltip.style.left = left + 'px';
    tooltip.style.top = top + 'px';
  });
  container.addEventListener('mouseout', e => {
    if (e.target.closest('.cal-cell')) tooltip.style.display = 'none';
  });
}

function renderHeatmap(data) {
  const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
  const maxCount = Math.max(...data.map(d => d.count), 1);
  const grid = {};
  data.forEach(d => { grid[d.day + '-' + d.hour] = d; });

  const isLightHm = document.documentElement.hasAttribute('data-theme');
  const hmGreen = isLightHm ? ['#9be9a8','#40c463','#30a14e','#216e39'] : ['#0e4429','#006d32','#26a641','#39d353'];
  const emptyBg = isLightHm ? '#ebedf0' : getCSSVar('--surface2');
  function hmColor(count, max) {
    if (!count) return emptyBg;
    const r = count / max;
    return r <= 0.25 ? hmGreen[0] : r <= 0.5 ? hmGreen[1] : r <= 0.75 ? hmGreen[2] : hmGreen[3];
  }

  let html = '<div class="heatmap"><div></div>';
  for (let h = 0; h < 24; h++) html += `<div class="heatmap-header">${h}</div>`;
  for (let d = 0; d < 7; d++) {
    html += `<div class="heatmap-label">${days[d]}</div>`;
    for (let h = 0; h < 24; h++) {
      const cell = grid[d + '-' + h];
      const count = cell ? cell.count : 0;
      const intensity = count / maxCount;
      const bg = hmColor(count, maxCount);
      html += `<div class="heatmap-cell" style="background:${bg}" title="${days[d]} ${h}:00 - ${count} sessions">${count || ''}</div>`;
    }
  }
  html += '</div>';
  document.getElementById('heatmap-container').innerHTML = html;
}

// ===== REFRESH =====
async function refreshData() {
  const btn = document.getElementById('refresh-btn');
  const progressEl = document.getElementById('refresh-progress');
  const stepEl = document.getElementById('refresh-step');
  const countEl = document.getElementById('refresh-count');
  const barEl = document.getElementById('refresh-bar');
  const concurrency = parseInt(document.getElementById('concurrency-select').value);

  btn.disabled = true;
  btn.textContent = 'Starting...';
  progressEl.style.display = 'block';
  stepEl.textContent = 'Requesting refresh...';
  countEl.textContent = '';
  barEl.style.width = '0%';

  try {
    const resp = await fetch('/api/refresh', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({concurrency}),
    });
    const result = await resp.json();
    if (!resp.ok) {
      stepEl.textContent = result.error || 'Error';
      btn.textContent = 'Run LLM Judge';
      btn.disabled = false;
      setTimeout(() => { progressEl.style.display = 'none'; }, 3000);
      return;
    }

    // Start polling for progress — reuses the same poller as init
    pollBackgroundStatus();
  } catch (e) {
    stepEl.textContent = 'Error: ' + e.message;
    btn.textContent = 'Run LLM Judge';
    btn.disabled = false;
    setTimeout(() => { progressEl.style.display = 'none'; }, 3000);
  }
}

// ===== INIT =====
async function init() {
  const progressEl = document.getElementById('refresh-progress');
  const stepEl = document.getElementById('refresh-step');
  const countEl = document.getElementById('refresh-count');
  const barEl = document.getElementById('refresh-bar');
  const btn = document.getElementById('refresh-btn');

  // Show progress bar during initialization
  progressEl.style.display = 'block';
  stepEl.textContent = 'Starting up...';
  barEl.style.width = '10%';
  countEl.textContent = '';

  // Connect to server and get initial config
  try {
    stepEl.textContent = 'Connecting to server...';
    barEl.style.width = '20%';
    const [projects, skillDims] = await Promise.all([
      api('/api/projects'),
      api('/api/skills/dimensions'),
    ]);
    populateFilters(projects.projects);
    window._skillDims = skillDims.dimensions;
  } catch (e) {
    // Server not up yet — show connecting state and retry
    stepEl.textContent = 'Server not ready, retrying...';
    barEl.style.width = '0%';
    setTimeout(init, 1000);
    return;
  }

  // Check if background worker is busy processing data
  stepEl.textContent = 'Checking background worker...';
  barEl.style.width = '30%';
  let status = await api('/api/status');

  // If worker is busy, wait for it to finish while showing its progress
  while (!status.ready) {
    // Show the worker's detailed progress
    stepEl.textContent = status.step || 'Processing...';
    if (status.total > 0) {
      const pct = Math.round(status.current / status.total * 100);
      barEl.style.width = pct + '%';
      countEl.textContent = `${status.current} / ${status.total}`;
    } else {
      barEl.style.width = '50%';
      countEl.textContent = '';
    }

    // Wait 1 second before checking again
    await new Promise(resolve => setTimeout(resolve, 1000));
    status = await api('/api/status');
  }

  // Worker is ready, now load the UI data
  countEl.textContent = ''; // Clear count - no meaningful progress here

  stepEl.textContent = 'Loading verdict...';
  barEl.style.width = '70%';
  await loadVerdict();

  stepEl.textContent = 'Loading prescriptions...';
  barEl.style.width = '75%';
  await loadChangeCards();

  stepEl.textContent = 'Loading synthesis...';
  barEl.style.width = '80%';
  await loadSynthesis();

  stepEl.textContent = 'Loading highlights...';
  barEl.style.width = '85%';
  await loadHighlights();

  stepEl.textContent = 'Loading sessions...';
  barEl.style.width = '88%';
  await loadSessions(false);

  stepEl.textContent = 'Loading charts...';
  barEl.style.width = '93%';
  await Promise.all([loadCharts(), loadProjectHealth(), loadSkills()]);

  // Complete!
  stepEl.textContent = 'Ready!';
  barEl.style.width = '100%';
  setTimeout(() => {
    progressEl.style.display = 'none';
  }, 1000);

  // Start simple polling for background status
  pollBackgroundStatus();

  // Load version info
  loadVersionInfo();
}

async function loadVersionInfo() {
  try {
    const version = await api('/api/version');
    const el = document.getElementById('version-info');
    el.textContent = `v${version.version} (${version.commit.substring(0, 7)})`;
    el.title = `Build date: ${version.build_date}`;
  } catch (e) {
    console.error('Failed to load version info:', e);
  }
}

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  // Ignore if typing in input/textarea
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
    return;
  }

  // r - Run LLM Judge
  if (e.key === 'r' && !e.ctrlKey && !e.metaKey) {
    e.preventDefault();
    const btn = document.getElementById('refresh-btn');
    if (btn && !btn.disabled) {
      btn.click();
    }
  }

  // e - Export to HTML
  if (e.key === 'e' && !e.ctrlKey && !e.metaKey) {
    e.preventDefault();
    window.location.href = '/api/export';
  }

  // j/k - Navigate sessions
  if ((e.key === 'j' || e.key === 'k') && !e.ctrlKey && !e.metaKey) {
    e.preventDefault();
    const sessions = Array.from(document.querySelectorAll('.s-card'));
    if (sessions.length === 0) return;

    let currentIndex = sessions.findIndex(s => s.classList.contains('expanded'));
    if (currentIndex === -1) {
      // No session expanded, expand first
      sessions[0].click();
    } else {
      // Navigate up/down
      const nextIndex = e.key === 'j'
        ? Math.min(currentIndex + 1, sessions.length - 1)
        : Math.max(currentIndex - 1, 0);
      if (nextIndex !== currentIndex) {
        sessions[nextIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
        sessions[nextIndex].click();
      }
    }
  }

  // / - Focus search
  if (e.key === '/' && !e.ctrlKey && !e.metaKey) {
    e.preventDefault();
    const si = document.getElementById('filter-search');
    if (si) { si.focus(); si.select(); }
  }

  // ? - Show help
  if (e.key === '?' && !e.ctrlKey && !e.metaKey) {
    e.preventDefault();
    alert(`Keyboard Shortcuts:

r - Run LLM Judge
/ - Focus search
j - Next session
k - Previous session
e - Export HTML
? - Show this help`);
  }
});

// Simple polling for background status (no SSE complexity)
let lastSeenState = null;

async function updateBackgroundStatus(status) {
  const progressEl = document.getElementById('refresh-progress');
  const stepEl = document.getElementById('refresh-step');
  const countEl = document.getElementById('refresh-count');
  const barEl = document.getElementById('refresh-bar');
  const btn = document.getElementById('refresh-btn');

  const currentState = status.ready ? 'idle' : status.state;

  if (!status.ready) {
    // Show inline progress bar (only if not already visible to avoid repaints)
    if (progressEl.style.display !== 'block') {
      progressEl.style.display = 'block';
    }
    stepEl.textContent = status.step || 'Working...';
    btn.disabled = true;
    btn.textContent = status.state === 'judging' ? 'Judging...' : 'Running...';

    if (status.total > 0) {
      const pct = Math.round(status.current / status.total * 100);
      barEl.style.width = pct + '%';
      countEl.textContent = `${status.current} / ${status.total}`;
    } else {
      barEl.style.width = '10%';
      countEl.textContent = '';
    }
  } else {
    // Background work is done
    btn.disabled = false;
    btn.textContent = 'Run LLM Judge';

    // If we just transitioned from working to idle, reload data
    if (lastSeenState !== null && lastSeenState !== 'idle' && currentState === 'idle') {
      stepEl.textContent = 'Complete!';
      barEl.style.width = '100%';
      countEl.textContent = '';

      await Promise.all([loadVerdict(), loadChangeCards(), loadSynthesis(), loadHighlights()]);
      expandedSessionId = null;
      await loadSessions(false);
      await Promise.all([loadCharts(), loadProjectHealth(), loadSkills()]);

      setTimeout(() => { progressEl.style.display = 'none'; }, 2000);
    } else {
      // Worker was already idle - hide progress immediately (avoid unnecessary repaints)
      if (progressEl.style.display !== 'none') {
        progressEl.style.display = 'none';
      }
    }
  }

  lastSeenState = currentState;
}

// Poll background status every 2 seconds
async function pollBackgroundStatus() {
  try {
    const status = await api('/api/status');
    await updateBackgroundStatus(status);
  } catch (e) {
    console.error('Failed to poll status:', e);
  }
  setTimeout(pollBackgroundStatus, 2000);
}

init();
</script>
</body>
</html>
